---
title: "Residence Time Experiment"
author: "Emmi Mueller"
date: "July 23, 2019"
output:
  pdf_document: default
  html_document: default
editor_options: 
  chunk_output_type: inline
---

##Setup
```{r setup, include = FALSE}
rm(list=ls())
getwd()

package.list <- c("Matrix", "jpeg", "cli", "png", "vegan", "ggplot2", "ggpubr", "cowplot", "ggpmisc", "scales", "fitdistrplus", "tidyr", "ade4", "viridis", "gplots", "BiodiversityR", "indicspecies", "knitr", "here", "dplyr", "BiocManager", "car", "here", "actuar", "tibble", "scales", "dplyr", "stringr", "iNEXT", "lmtest", "betapart", "reshape2", "mgcv", "modelr", "purrr", "lme4", "tidymv", "merTools", "MuMIn", "htmltools", "ggrepel")

for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package, dependencies = TRUE)
    library(package, character.only=T)
  } }

#BiocManager::install()
#BiocManager::install(c("flowCore", "ggcyto"))

source("./code/residence-time-test_functions.R")
source("./code/mothur_tools.R")
```

##Set up figure theme
```{r figure_setup}
my.cols <- RColorBrewer::brewer.pal(n = 4, name = "Greys")[3:4]

# Set theme for figures in the paper
theme_set(theme_classic() + 
  theme(axis.title = element_text(size = 16),
        axis.title.x = element_text(margin = margin(t = 15, b = 15)),
        axis.title.y = element_text(margin = margin(l = 15, r = 15)),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(margin = margin(t = 5)),
        axis.text.y = element_text(margin = margin(r = 5)),
        #axis.line.x = element_line(linewidth = 1),
        #axis.line.y = element_line(linewidth = 1),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.x = element_line(linewidth = 1),
        axis.ticks.y = element_line(linewidth = 1),
        axis.ticks.length = unit(.1, "in"),
        panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        legend.text = element_text(size = 10),
        strip.text = element_text(size = 14),
        strip.background = element_blank()
        ))
```


```{r}
#Define Inputs

#Tau = general design file for experiment, paired Day 0 and 20
Tau <- read.csv("data/RTLC/2021_RTLC_Tau_Combined.csv", header = TRUE)
Tau_ctrl <- Tau[50:51,]
Tau <- Tau[1:49,]
Tau$Tau <- as.numeric(Tau$Tau)
Tau$Set <- as.character(Tau$Set)
Tau$Day_0_Seq[Tau$Day_0_Seq == ""] <- NA
Tau$Day_20_Seq[Tau$Day_20_Seq == ""] <- NA

#Tau_Seq = Full list of sequenced samples, non-paired Day 0 and 20
Tau_Seq <- read.csv("data/RTLC/2021_RTLC_Tau_Seq.csv", header = TRUE)

#Import Shared Files
OTUs <- read.otu(shared = "mothur/RTLC.final.shared", cutoff = "0.03")
rownames(OTUs)[rownames(OTUs) == "GSF3365_RTLC"] <- "GSF3365_RTLC_002"

#Import Taxonomy
OTU.tax <- read.tax(taxonomy = "mothur/RTLC.final.taxonomy", format = "rdp")

#Abundance data
Tau <- N_fxn(read.csv("data/RTLC/RTLC_S1/20210602_RTLC_S1_N.csv", header = TRUE), Tau)
Tau <- N_fxn(read.csv("data/RTLC/RTLC_S2/20210628_RTLC_S2_N_RSG.csv", header = TRUE), Tau)
Tau <- N_fxn(read.csv("data/RTLC/RTLC_S3/20210723_RTLC_S3_N_RSG.csv", header = TRUE), Tau)
Tau <- N_fxn(read.csv("data/RTLC/RTLC_S4/20210904_RTLC_S4_N_RSG.csv", header = TRUE), Tau)


#Biofilm data
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S1/20210602_RTLC_S1_Otoole.csv", header = TRUE), Tau)
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S2/20210628_RTLC_S2_Otoole.csv", header = TRUE), Tau)
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S3/20210723_RTLC_S3_Otoole.csv", header = TRUE), Tau)
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S4/20210904_RTLC_S4_Otoole.csv", header = TRUE), Tau)


#BP data
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S1/20210602_RTLC_S1_BP.csv", header = FALSE), Tau, 1))
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S2/20210628_RTLC_S2_BP.csv", header = FALSE), Tau, 2))
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S3/20210723_RTLC_S3_BP.csv", header = FALSE), Tau, 3))
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S4/20210904_RTLC_S4_BP.csv", header = FALSE), Tau, 4))
Tau$ind_P <- Tau$uMChr/Tau$N


#Biolog data
Tau <- EP_fxn(read.csv("data/RTLC/eco.data_rt.txt", header = TRUE, sep = "\t"), Tau)

Tau$Set <- as.factor(Tau$Set)


Tau$Tau <- log(((10^Tau$Tau)/60), 10)

Tau$N_turn <- (20 * 24)/(10^Tau$Tau)

Tau$Turn <- Tau$Tau <= log(24*20, 10)

Tau$Pump <- Tau$Tau < 1.6
```



##Read in all EcoPlate 48 hour data and create a resource by sample matrix (wbs - well response by site) and environmental matrix (env - Tau only)

```{r}
EcoPlate <- read.csv("data/RTLC/eco.data_rt_S1_48.txt", header = TRUE, sep = "\t")
EcoPlate <- rbind(EcoPlate, read.csv("data/RTLC/eco.data_rt_S2_48.txt", header = TRUE, sep = "\t"))
EcoPlate <- rbind(EcoPlate, read.csv("data/RTLC/eco.data_rt_S3_48.txt", header = TRUE, sep = "\t"))
EcoPlate <- rbind(EcoPlate, read.csv("data/RTLC/eco.data_rt_S4_48.txt", header = TRUE, sep = "\t"))
EcoPlate_env <- subset(EcoPlate, select = c(Tau, Set))
rownames(EcoPlate) <- EcoPlate$Tau
EcoPlate <- subset(EcoPlate, select =-c(Tau, NumRes, Avg, Set, Hours))
```

##Clean and rarefy the OTU table
```{r}
#Remove samples with fewer than 10000 reads
coverage <- rowSums(OTUs)
cutoff <- 10000
lows <- which(coverage < cutoff)
if (length(lows) > 0){
  OTUs <- OTUs[-which(coverage < cutoff),]
}

#Remove OTUs with less thatn 2 reads across all samples
OTUs <- OTUs[,which(colSums(OTUs) > 2)]

#Generate rarefacation plot
otu.min <- min(rowSums(OTUs))

# png("./output/OTU_rarefaction.png", width = 800, height = 480)
# par(mar = c(1, 1, 1, 1) + 0.1)
#   rarecurve(x = OTUs, step = 100, sample = otu.min, col = "blue", cex = 0.6, las = 1)
# #  abline(0,1, col = "red")
# #  text(1500, 1500, "1:1", pos = 2, col = "red")
# dev.off()

#rarefy OTUs to the sample with the lowest number of reads then remove OTUs with 0 reads after rarefaction
set.seed(47405)
OTU_r <- rrarefy(OTUs, otu.min)
OTU_r <- OTU_r[,-which(colSums(OTU_r) == 0)]
rm(OTUs)

Tau_20 <- subset(Tau[is.na(Tau$Day_20_Seq) == 0,])
Tau_Seq$Day <- as.factor(Tau_Seq$Day)
Tau_Seq$Tau <- as.numeric(Tau_Seq$Tau)

#Generate OTU tables with p/a, relative abundance
OTUsREL <-decostand(OTU_r, method = "total")
OTUsREL_20 <- OTUsREL[rownames(OTUsREL) %in% unique(Tau$Day_20_Seq),]
OTUsREL_20 <- OTUsREL_20[,which(colSums(OTUsREL_20) > 0)]
rownames(OTUsREL_20) <- subset(Tau_Seq, Day == 20)$Tau
# 
# OTUs.PA <- decostand(OTU_r, method = "pa")
# OTUsPA_20<- OTUs.PA[rownames(OTUs.PA) %in% unique(Tau$Day_20_Seq),]
# OTUsPA_20 <- OTUsPA_20[,which(colSums(OTUsPA_20) > 0)]
# rownames(OTUsPA_20) <- subset(Tau_Seq, Day == 20)$Tau


OTUsr_20 <- OTU_r[rownames(OTU_r) %in% unique(Tau$Day_20_Seq),]
OTUsr_20 <- OTUsr_20[,which(colSums(OTUsr_20) >0)]
rownames(OTUsr_20) <- subset(Tau_Seq, Day == 20)$Tau
unique(colnames(OTUsr_20))

OTU.tax.20 <- OTU.tax[OTU.tax$OTU %in% unique(colnames(OTUsr_20)),]

Tau_Seq$ACE <- S.ace(OTU_r)

#
S <- as.data.frame(cbind(row.names(OTU_r), unname(S.cal(OTU_r))))
Tau <- S_fxn(S, Tau)
Tau$Day_20.S <- as.numeric(Tau$Day_20.S)
Tau$Day_0.S <- as.numeric(Tau$Day_0.S)

SimpE <- as.data.frame(cbind(row.names(OTU_r), unname(SimpE.cal(OTU_r))))
Tau <- SimpE_fxn(SimpE, Tau)
Tau$Day_0.SimpE <- as.numeric(Tau$Day_0.SimpE)
Tau$Day_20.SimpE <- as.numeric(Tau$Day_20.SimpE)
```


```{r}
IBM_R <- read.csv("../residence-time/Model/results/data/SimData.csv", header = TRUE, sep = ",")
IBM_R_long <- as.data.frame(unique(IBM_R$sim))
colnames(IBM_R_long) <- c("sim")
IBM_R_long$ct <- rep(c(1000), 50)

for(x in unique(IBM_R_long$sim)){
  IBM_R_long[IBM_R_long$sim == x, "V"] <- mean(subset(IBM_R, IBM_R$sim == x)$V)
  IBM_R_long[IBM_R_long$sim == x, "Q"] <- mean(subset(IBM_R, IBM_R$sim == x)$Q)
  IBM_R_long[IBM_R_long$sim == x, "N"] <- mean(subset(IBM_R, IBM_R$sim == x)$total.abundance)
  IBM_R_long[IBM_R_long$sim == x, "R"] <- mean(subset(IBM_R, IBM_R$sim == x)$resource.particles)
  IBM_R_long[IBM_R_long$sim == x, "P"] <- mean(subset(IBM_R, IBM_R$sim == x)$ind.production)
}

IBM_R_long$N_turn <- IBM_R_long$ct/(IBM_R_long$V/IBM_R_long$Q)
IBM_R_long$turn <- IBM_R_long$N_turn > 1
IBM_R_long$ct_f <- as.factor(IBM_R_long$ct)
IBM_R_long$Tau <- log(IBM_R_long$V/IBM_R_long$Q, 10)

plot(IBM_R_long$R ~ IBM_R_long$Tau)
plot(IBM_R_long$P ~ IBM_R_long$Tau)
plot(IBM_R_long$N ~ IBM_R_long$Tau)
```

```{r}
N_RSG <- read.csv("./data/RTLC/2021_RTLC_RSG_N.csv", header = TRUE)
N_RSG$DorPer <- (N_RSG$N-N_RSG$RSG)/N_RSG$N
N_RSG$Tau <- log(((10^N_RSG$Tau)/60), 10)

Dorm_gam <- gam(data = N_RSG, (DorPer * 100) ~ s(Tau), family = gaussian(link = "identity"), method = "REML")
Dorm_gam_re <- gam(data = N_RSG, (DorPer * 100) ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), method = "REML")
summary(Dorm_gam)
AIC(Dorm_gam, Dorm_gam_re)
plot(Dorm_gam)
k.check(Dorm_gam)
gam.check(Dorm_gam)

Dorm <- ggplot(data = N_RSG, aes(y = (DorPer * 100), x = Tau))+
  geom_point()+
  xlab(expression(paste(tau, " (hrs)")))+
  ylab("% Dormancy")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

Dorm

Dorm_Tau <- predict_gam(Dorm_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = N_RSG, aes(x = Tau, y = (DorPer * 100)))+
  xlab(expression(paste(tau, " (hrs)")))+
  ylab("% Dormancy")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(Dorm_gam)$r.sq, 2))))

Dorm_Tau


ggsave("./output/RTLC_Dorm.pdf")
ggsave("./output/RTLC_Dorm.png")

```



#Figure 1. Community Structure

##Cstat - Microbial abundance
```{r}
test <- as.data.frame(seq(0, 0.1, 0.0001))
colnames(test) <- "n"
for(i in seq(0, 0.1, 0.0001)){
  N_gam_re <- gam(log_N ~ s(Tau, sp = i) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")
  test[test$n == i, "AIC"] <- N_gam_re$aic
  test[test$n == i, "REML"] <- N_gam_re$gcv.ubre[[1]]
}

plot(test$AIC ~ test$n)
plot(test$REML ~ test$n, ylim = c(0,30))

N_gam <- gam(log_N ~ s(Tau), family = gaussian(link = "identity"), data = Tau, method = "REML")
N_gam_re <- gam(log_N ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

AIC(N_gam, N_gam_re)
anova(N_gam, N_gam_re, test = "Chisq")

summary(N_gam_re)
k.check(N_gam_re)
gam.check(N_gam_re)

gam.vcomp(N_gam_re)

N_Tau <- predict_gam(N_gam_re, exclude_terms = "s(Set)") %>%
  filter(Set == "1") %>% 
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = Tau, aes(x = Tau, y = log_N))+
  theme(axis.title.x = element_blank())+
  ylab("N (cells/mL)")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(N_gam_re)$r.sq, 2))))

N_Tau

ggsave("./output/RTLC_N.pdf")
ggsave("./output/RTLC_N.png")
```

##Cstat - Observed Richness
```{r}
test <- as.data.frame(seq(0, 0.1, 0.0001))
colnames(test) <- "n"
for(i in seq(0, 0.1, 0.0001)){
  S_gam_re <- gam(log(Day_20.S, 10) ~ s(Tau, sp = i) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")
  test[test$n == i, "AIC"] <- S_gam_re$aic
  test[test$n == i, "REML"] <- S_gam_re$gcv.ubre[[1]]
}

plot(test$AIC ~ test$n)
plot(test$REML ~ test$n, ylim = c(-50,-20))

S_gam <- gam(Day_20.S ~ s(Tau, k = 14), family = gaussian(link = "identity"), data = Tau, method = "REML")
S_gam_re <- gam(Day_20.S ~ s(Tau)  + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

k.check(S_gam)
gam.check(S_gam)

AIC(S_gam, S_gam_re)
anova(S_gam, S_gam_re, test = "Chisq")

summary(S_gam_re)
k.check(S_gam_re)
gam.check(S_gam_re)

S.ob_Tau <- predict_gam(S_gam_re, exclude_terms = "s(Set)") %>%
  filter(Set == "1") %>% 
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = Tau, aes(x = Tau, y = Day_20.S))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
#  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Observed S")+
  theme(axis.title.x = element_blank())+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(S_gam_re)$r.sq, 2))))
  

S.ob_Tau

ggsave("./output/RTLC_S.pdf")
ggsave("./output/RTLC_S.png")
```

#Cstat - Simpson's Evenness (E[1/D])
```{r}
test <- as.data.frame(seq(0, 0.1, 0.0001))
colnames(test) <- "n"
for(i in seq(0, 0.1, 0.0001)){
  SimpE_gam <- gam(Day_20.SimpE ~ s(Tau, sp = i), family = gaussian(link = "identity"), data = Tau, method = "REML")
  test[test$n == i, "AIC"] <- SimpE_gam$aic
  test[test$n == i, "REML"] <- SimpE_gam$gcv.ubre[[1]]
}

plot(test$AIC ~ test$n)
plot(test$REML ~ test$n)

SimpE_gam <- gam(Day_20.SimpE ~ s(Tau, k = 15), family = gaussian(link = "identity"), data = Tau, method = "REML")
SimpE_gam_re <- gam(Day_20.SimpE ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

AIC(SimpE_gam, SimpE_gam_re)
anova(SimpE_gam, SimpE_gam_re, test = "Chisq")

summary(SimpE_gam)
k.check(SimpE_gam)
gam.check(SimpE_gam)

SimpE_Tau <- predict_gam(SimpE_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = Tau, aes(x = Tau, y = Day_20.SimpE))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab(expression("E"[D^"-1"/S]))+
  xlab(expression(paste(tau, " (hrs)")))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(SimpE_gam)$r.sq, 2))))

SimpE_Tau

ggsave("./output/RTLC_SimpE.pdf")
ggsave("./output/RTLC_SimpE.png")

```

```{r}
IBMmod <- read.csv("data/IBM/SimData_hrs.csv", header = TRUE, sep = ",")

IBMmod_long <- as.data.frame(rep(unique(IBM_mod$sim)))
colnames(IBMmod_long) <- c("sim")
IBMmod_long$ct <- rep(c(480), 50)

for(x in unique(IBMmod_long$sim)){
  IBMmod_long[IBMmod_long$sim == x, "V"] <- mean(subset(IBMmod, IBMmod$sim == x)$V)
  IBMmod_long[IBMmod_long$sim == x, "Q"] <- mean(subset(IBMmod, IBMmod$sim == x)$Q)
  IBMmod_long[IBMmod_long$sim == x, "N"] <- mean(subset(IBMmod, IBMmod$sim == x)$total.abundance)
  IBMmod_long[IBMmod_long$sim == x, "S"] <- mean(subset(IBMmod, IBMmod$sim == x)$species.richness)
  IBMmod_long[IBMmod_long$sim == x, "E"] <- mean(subset(IBMmod, IBMmod$sim == x)$simpson.e, na.rm = TRUE)
  IBMmod_long[IBMmod_long$sim == x, "P"] <- mean(subset(IBMmod, IBMmod$sim == x)$ind.production, na.rm = TRUE)
  IBMmod_long[IBMmod_long$sim == x, "B"] <- mean(subset(IBMmod, IBMmod$sim == x)$whittakers.turnover, na.rm = TRUE)
  IBMmod_long[IBMmod_long$sim == x, "Res"] <- mean(subset(IBMmod, IBMmod$sim == x)$avg.per.capita.efficiency1e, na.rm = TRUE)
}

IBMmod_long$N_turn <- IBMmod_long$ct/(IBMmod_long$V/IBMmod_long$Q)
IBMmod_long$turn <- IBMmod_long$N_turn > 1
IBMmod_long$ct_f <- as.factor(IBMmod_long$ct)
IBMmod_long$Tau <- log(IBMmod_long$V/IBMmod_long$Q, 10)

write.csv(IBMmod_long, "data/IBM/IBMmod_long.csv", row.names = FALSE)

IBMmod_long <- read.csv("data/IBM/IBMmod_long.csv", header = TRUE, sep = ",")
IBMmod_long$ct_f <- as.factor(IBMmod_long$ct)

IBM_R2_N6 <- read.csv("data/IBM/IBM_R2_N6.csv", header = TRUE, sep = ",")
IBM_R2_N6$ct_f <- as.factor(IBM_R2_N6$ct)
```

##IBM - N
```{r}
N_IBM_gam <- gam(log(N, 10) ~ s(Tau), family = gaussian(link = "identity"), data = subset(IBMmod_long, IBMmod_long$N > 0), method = "REML")

summary(N_IBM_gam)

N_IBM <- predict_gam(N_IBM_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = subset(IBMmod_long, IBMmod_long$N > 0), aes(x = Tau, y = log(N, 10)))+
  ylab("N (number of individuals)")+
  theme(axis.title.x = element_blank())+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(N_IBM_gam)$r.sq, 2))))

N_IBM

ggsave("./output/IBM_N.pdf")
ggsave("./output/IBM_N.png", width = 6.5, height = 5)
```

#IBM - S
```{r}
S_IBM_gam <- gam(log(S, 10) ~ s(Tau), family = gaussian(link = "identity"), data = subset(IBMmod_long, IBMmod_long$S > 0), method = "REML")

summary(S_IBM_gam)

S_IBM <- predict_gam(S_IBM_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = subset(IBMmod_long, IBMmod_long$S > 0), aes(x = Tau, y = log(S, 10)))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Observed S")+
  theme(axis.title.x = element_blank())+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(S_IBM_gam)$r.sq, 2))))

S_IBM

ggsave("./output/IBM_S.pdf")
ggsave("./output/IBM_S.png", width = 6.5, height = 5)
```

#IBM - E
```{r}
E_IBM_gam <- gam(E ~ s(Tau), family = gaussian(link = "identity"), data = IBMmod_long, method = "REML")

summary(E_IBM_gam)

E_IBM <- predict_gam(E_IBM_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = IBMmod_long, aes(x = Tau, y = E))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab(expression("E"[D^"-1"/S]))+
  xlab(expression(paste(tau, " (time steps)")))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(E_IBM_gam)$r.sq, 2))))

E_IBM

ggsave("./output/IBM_E.pdf")
ggsave("./output/IBM_E.png", width = 6.5, height = 5)
```

##Draw Figure
```{r}
ggdraw()+
  draw_plot(N_IBM, x = 0, y = 0.65, width = 0.5, height = 0.3) +
  draw_plot(N_Tau, x = 0.5, y = 0.65, width = 0.5, height = 0.3) + 
  draw_plot(S_IBM, x = 0, y = 0.35, width = 0.5, height = 0.3) +
  draw_plot(S.ob_Tau, x = 0.5, y = 0.35, width = 0.5, height = 0.3) + 
  draw_plot(E_IBM, x = 0, y = 0.0, width = 0.5, height = 0.35) + 
  draw_plot(SimpE_Tau, x = 0.5, y = 0.0, width = 0.5, height = 0.35)+
  draw_plot_label(label = c("IBM predictions", "Chemostat results"), size = 20, x = c(0,0.5), y = c(1,1))+
  draw_plot_label(label = c("A", "B", "C"), size = 30, x = c(0.06,0.06,0.06), y = c(0.96,0.65,0.35))+
  theme(plot.background = element_rect(fill="white", color = NA))

ggsave("./output/CommStr.pdf")
ggsave("./output/CommStr.png", width = 10, height = 10)

ggdraw()+
  draw_plot(N_Tau, x = 0, y = 0.65, width = 1, height = 0.3) + 
  draw_plot(S.ob_Tau, x = 0, y = 0.35, width = 1, height = 0.3) + 
  draw_plot(SimpE_Tau, x = 0, y = 0.0, width = 1, height = 0.35)+
  draw_plot_label(label = c("A", "B", "C"), size = 30, x = c(0.06,0.06,0.06), y = c(0.96,0.65,0.35))+
  theme(plot.background = element_rect(fill="white", color = NA))

ggsave("./output/CommStr_Cstat.pdf")
ggsave("./output/CommStr_Cstat.png", width = 5, height = 10)
```
#Figure 2. Community composition


##Generate PCoA of Day 20 samples using BC distance
```{r}
Tau.otus <- log((10^as.numeric(rownames(OTUsr_20))/60), 10)
                
adonis2(OTUsr_20 ~ Tau.otus, method = "bray", permutations = 999)
adonis2(OTUsr_20 ~ tau.plot$Turn, method = "bray", permutations = 999)

#DNA_corr <- as.data.frame(matrix(NA, dim()))

tau.db <- vegdist(OTUsr_20, method = "bray", upper = TRUE, diag = TRUE)

tau.pcoa <- cmdscale(tau.db, eig = TRUE, k = 3)
explainvar1 <- round(tau.pcoa$eig[1] / sum(tau.pcoa$eig), 3) *100
explainvar2 <- round(tau.pcoa$eig[2] / sum(tau.pcoa$eig), 3) *100
explainvar3 <- round(tau.pcoa$eig[3] / sum(tau.pcoa$eig), 3) *100
sum.eig <- sum(explainvar3, explainvar2, explainvar1)

tau.plot <- as.data.frame(tau.pcoa$points)
tau.plot <- cbind(tau.plot, Tau_20)
tau.plot$Pump <- factor(tau.plot$Pump, levels=c("TRUE", "FALSE"))
tau.plot$Turn <- factor(tau.plot$Turn, levels=c("TRUE", "FALSE"))

spe.corr <- add.spec.scores(tau.pcoa, OTUsREL_20, method = "cor.scores")$cproj
corrcut <- 0.7
imp.spp <- as.data.frame(spe.corr[abs(spe.corr[,1]) >= corrcut | abs(spe.corr[,2]) >= corrcut,])
imp.spp <- na.omit(imp.spp)

imp.tax <- subset(OTU.tax, OTU == rownames(imp.spp)[1])

x <- 2                        
while (x <= nrow(imp.spp)){
  imp.tax <- rbind(imp.tax, subset(OTU.tax, OTU == rownames(imp.spp)[x]))
  x <- x + 1
}

imp.spp <- cbind(imp.spp, imp.tax)

imp.otus <- as.data.frame(row.names(OTUsREL_20))
imp.spp.otu <- c()
for(otu in unique(imp.spp$OTU)){
    imp.otus <- cbind(imp.otus, OTUsREL_20[,otu])
    imp.spp.otu <- c(imp.spp.otu, otu)
}
colnames(imp.otus) <- c("Tau", imp.spp.otu)
imp.otus$Tau <- log(((10^as.numeric(imp.otus$Tau))/60), 10)


for(x in unique(imp.spp$Phylum)){
  list <- data.frame(rep(0, 35))
  colnames(list) <- c(as.character(x))
  for(y in imp.spp$OTU){
    if(imp.spp[y, "Phylum"] == x){
      list[,x] <- list[,x] + as.data.frame(imp.otus[,y])
    }
  }
  imp.otus[,as.character(x)] <- list[,x]
}

imp.phylum <- cbind(imp.otus$Tau, imp.otus[ ,331:350])
colnames(imp.phylum) <- c("Tau", colnames(imp.otus[,331:350]))
imp.phylum.long <- gather(imp.phylum, phylum, REL, Proteobacteria:Bdellovibrionota)

imp.phylum.long$Tau <- as.numeric(imp.phylum.long$Tau)

imp_phylum_plot <- ggplot(imp.phylum.long, aes(x = Tau, y = REL, group = phylum))+
  geom_smooth(method = "loess", se = F, aes(color = phylum))+
  ylab("Relative abundance")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(color = "Phylum")+
  xlab(expression(paste(tau, " (hrs)")))+
  theme(legend.title = element_text(size = 20), legend.text = element_text(size = 15), axis.title = element_text(size = 20))
imp_phylum_plot

ggsave("./output/RTLC_imp_phylum.pdf")
ggsave("./output/RTLC_imp_phylum.png", width = 12, height = 8)



taxa <- as.data.frame(imp.otus$Tau)
for(x in unique(OTU.tax.20$Phylum)){
  list <- data.frame(rep(0, 35))
  colnames(list) <- c(as.character(x))
  for(y in OTU.tax.20$OTU){
    if(subset(OTU.tax.20, OTU.tax.20$OTU == y)$Phylum == x){
      list[,x] <- list[,x] + as.data.frame(OTUsr_20[,y])
    }
  }
  taxa[,as.character(x)] <- list[,x]
}
rownames(taxa) <- taxa$`imp.otus$Tau`
taxa.20 <- taxa[,-1]
taxa.20.rel <- decostand(taxa.20, method = "total")
taxa.20.rel <- cbind(imp.otus$Tau, taxa.20.rel)
colnames(taxa.20.rel) <- c("Tau", unique(OTU.tax.20$Phylum))
taxa.20.long <- gather(taxa.20.rel, phylum, REL, Proteobacteria:Calditrichota)

phylum_plot <- ggplot(taxa.20.long, aes(x = Tau, y = REL, group = phylum))+
  geom_smooth(method = "loess", se = F, aes(color = phylum))+
  ylab("Relative abundance")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(color = "Phylum")+
  xlab(expression(paste(tau, " (hrs)")))+
  theme(legend.title = element_text(size = 20), legend.text = element_text(size = 15), axis.title = element_text(size = 20))
#  theme(legend.position = "none", axis.title = element_text(size = 20))
phylum_plot

ggsave("./output/RTLC_rel_phylum.pdf")
ggsave("./output/RTLC_rel_phylum.png", width = 12, height = 8)


Dim1 <- c()
Dim2 <- c()
Dim3 <- c()
for(x in unique(imp.spp$Phylum)){
  Dim1 <- c(Dim1, mean(as.numeric(subset(imp.spp, imp.spp$Phylum == x)$Dim1)))
  Dim2 <- c(Dim2, mean(as.numeric(subset(imp.spp, imp.spp$Phylum == x)$Dim2)))
  Dim3 <- c(Dim3, mean(as.numeric(subset(imp.spp, imp.spp$Phylum == x)$Dim3)))
}

spe.corr.means <- as.data.frame(unique(imp.spp$Phylum))
spe.corr.means <- cbind(spe.corr.means, as.vector(Dim1), as.vector(Dim2), as.vector(Dim3))
colnames(spe.corr.means) <- c("Phylum", "Dim1", "Dim2", "Dim3")

tau.plot <- tau.plot[order(as.numeric(tau.plot$Tau)),]
OTUsr_20 <- OTUsr_20[order(as.numeric(row.names(OTUsr_20))),]

# pcoa.mean=aggregate(tau.plot[,1:2],list(group=tau.plot$Turn),mean)
# 
# veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
# {
#   theta <- (0:npoints) * 2 * pi/npoints
#   Circle <- cbind(cos(theta), sin(theta))
#   t(center + scale * t(Circle %*% chol(cov)))
# }
#  
# df_ell <- data.frame()
# for(g in levels(tau.plot$Turn)){
#     df_ell <- rbind(df_ell,cbind(as.data.frame(with(tau.plot[tau.plot$Turn==g,], veganCovEllipse(cov.wt(cbind(V1,V2),wt=rep(1/length(V1),length(V1)))$cov,center=c(mean(V1),mean(V2))))), group=g))
# }

install.packages("ggordiplots")
library("ggordiplots")

my.plot <- gg_ordiplot(tau.pcoa, groups = Tau_20$Turn, ellipse = TRUE)

plot.ellipse <- my.plot$plot
plot.ellipse
ggsave("./output/RTLC_PCoA_ellipse.pdf")
ggsave("./output/RTLC_PCoA_ellipse.png", width = 8, height = 5)


#PCoA <- ggplot(tau.plot, aes(x = V1, y = V2, label = round(Tau, 2)))+
PCoA <- ggplot(tau.plot, aes(x = V1, y = V2))+
  geom_path(linewidth = 1.25, color = alpha("black", 0.2))+
  geom_point(cex = 3, aes(shape = Turn, color = as.numeric(Tau)))+
#  geom_text(hjust = 0, vjust = 0)+
#  geom_text_repel(data = tau.plot, size = 3, aes(x = V1, y = V2, label = round(Tau, 2)))+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(shape = "Full Turnover", color = expression(paste(tau,  " (hrs)")))+
  scale_shape_manual(values = c(15, 19), labels = c("Yes", "No"))+
  scale_color_viridis(direction = -1, labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 14))+
  geom_path(data=subset(df_ell, df_ell$group == TRUE), aes(x=V1, y=V2), size=1, linetype=2, color = "red")+
  geom_path(data=subset(df_ell, df_ell$group == FALSE), aes(x=V1, y=V2), size=1, linetype=2, color = "red")
#  geom_text_repel(data = spe.corr.means, size = 3, aes(x = Dim1, y = Dim2, label = Phylum))

PCoA

ggsave("./output/RTLC_BC_PCoA.pdf")
ggsave("./output/RTLC_BC_PCoA.png", width = 8, height = 5)
```

```{r}
OTU_pumpturn <- ggplot(tau.plot, aes(x = V1, y = V2))+
#  geom_point(cex = 3, aes(colour = as.numeric(Tau)))+
  geom_path(linewidth = 1.25, color = alpha("black", 0.2))+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  geom_point(cex = 3, aes(shape = Turn, color = Pump))+
  labs(shape = "Number of\nturnovers", color = "Treatment\nmethod")+
  scale_color_manual(values = c("blue", "black"), labels = c("Pump", "Manual"))+
  scale_shape_manual(values = c(19, 1), labels = c("> 1", "< 1"))+
  theme(legend.title = element_text(size = 14))

OTU_pumpturn

ggsave("./output/RTLC_BC_OTUpumpturn.pdf")
ggsave("./output/RTLC_BC_OTUpumpturn.png", width = 8, height = 5)
```
```{r}
PCoA1_gam <- gam(V1 ~ s(Tau), family = gaussian(link = "identity"), data = tau.plot, method = "REML")

AIC(PCoA1_gam)
gam.check(PCoA1_gam)
summary(PCoA1_gam)

PCoA1 <- predict_gam(PCoA1_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = tau.plot, aes(x = Tau, y = V1), size = 2, alpha = 0.6)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(PCoA1_gam)$r.sq, 3))))+
  theme(axis.title.x = element_blank())

PCoA1

ggsave("./output/RTLC_BC_PCoA1.pdf")
ggsave("./output/RTLC_BC_PCoA1.png", width = 6.5, height = 5)

PCoA2_gam <- gam(V2 ~ s(Tau), family = gaussian(link = "identity"), data = tau.plot, method = "REML")

PCoA2 <- predict_gam(PCoA2_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = tau.plot, aes(x = Tau, y = V2), size = 2, alpha = 0.6)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau, " (hrs)")))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(PCoA2_gam)$r.sq, 3))))

PCoA2

ggsave("./output/RTLC_BC_PCoA2.pdf")
ggsave("./output/RTLC_BC_PCoA2.png")
```

##Draw Figure
```{r}
ggdraw()+
  draw_plot(PCoA, x = 0, y = 0.5, width = 1, height = 0.5) +
  draw_plot(imp_phylum_plot, x = 0, y = 0, width = 1, height = 0.5) + 
  theme(plot.background = element_rect(fill="white", color = NA))+
  draw_plot_label(label = c("A", "B"), size = 30, x = c(0,0), y = c(0.98,0.48))

ggsave("./output/CommPCoA.pdf")
ggsave("./output/CommPCoA.png", width = 10, height = 10)

ggdraw()+
  draw_plot(PCoA1, x = 0, y = 0.55, width = 1, height = 0.45) +
  draw_plot(PCoA2, x = 0, y = 0, width = 1, height = 0.55) + 
  theme(plot.background = element_rect(fill="white", color = NA))+
  draw_plot_label(label = c("A", "B"), size = 30, x = c(0,0), y = c(0.98,0.48))

ggsave("./output/CommPCoA_axes.pdf")
ggsave("./output/CommPCoA_axes.png", width = 8, height = 10)
```


#Figure 4. Community Function - P

##Cstat - Biomass Production (uM C/hr)

```{r}
# BP_lm <- lm(uMChr ~ Tau, data = Tau)
# BP_poly <- lm(uMChr ~ poly(Tau, 2, raw = TRUE), data = Tau)
# BP_gam <- gam(uMChr ~ s(Tau), family = gaussian(link = "identity"), data = Tau, method = "REML")
# BP_gam_gm <- gam(uMChr ~ s(Tau), family = Gamma(link = "log"), data = Tau, method = "REML")
# 
# AIC(BP_lm, BP_poly, BP_gam, BP_gam_gm)

BP_gam_re_sp <- gam(log(uMChr, 10) ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

# BP_gam_gm_re <- gam(uMChr ~ s(Tau) + s(Set, bs = "re"), family = Gamma(link = "log"), data = Tau, method = "REML")
# BP_gam_gm_re_sp <- gam(uMChr ~ s(Tau, sp = 0.2) + s(Set, bs = "re"), family = Gamma(link = "log"), data = Tau, method = "REML")

# anova(BP_gam_gm, BP_gam_gm_re, test = "Chisq")

summary(BP_gam_re_sp)
k.check(BP_gam_re_sp)
gam.check(BP_gam_re_sp)

BP_Tau <- predict_gam(BP_gam_re_sp, exclude_terms = "s(Set)") %>%
  filter(Set == "1") %>% 
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = Tau, aes(x = Tau, y = log(uMChr, 10)))+
#  xlab(expression(paste(tau, " (hrs)")))+
  ylab(expression(paste("Bacterial Productivity (", mu, "mol C/hr)")))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(BP_gam_re_sp)$r.sq, 2))))+
#  theme(plot.margin = unit(c(1.5, 0.2, 0, 0.2), "cm"), axis.title.x = element_blank())+
  theme(axis.title.x = element_blank())

BP_Tau

ggsave("./output/RTLC_BP.pdf")
ggsave("./output/RTLC_BP.png", width = 6.5, height = 5)
```

#IBM - P
```{r}
P_IBM_gam <- gam(log(P + 1, 10) ~ s(Tau), family = gaussian(link = "identity"), data = IBMmod_long, method = "REML")

summary(P_IBM_gam)

P_IBM <- predict_gam(P_IBM_gam) %>%
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = IBMmod_long, aes(x = Tau, y = log(P + 1, 10)))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Productivity")+
  xlab(expression(paste(tau, " (time steps)")))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(P_IBM_gam)$r.sq, 2))))+
  theme(plot.margin = unit(c(1.5, 0.2, 0, 0.2), "cm"))

P_IBM

ggsave("./output/IBM_P.pdf")
ggsave("./output/IBM_P.png", width = 6.5, height = 5)
```


##Average well response at 48 hours
```{r}

summary(Avg_lm)

AIC(Avg_lm, Avg_lm2)

summary(Avg_lm)
Avg_lm <- lm(AvgRes ~ Tau, data = Tau)
Avg_lm2 <- lm(log(AvgRes, 10) ~ Tau, data = Tau)
Avg_poly <- lm(AvgRes ~ poly(Tau, 2, raw = TRUE), data = Tau)
Avg_log_re <- lmer(AvgRes ~ Tau + (1|Set), data = Tau)
Avg_gam <- gam(AvgRes ~ s(Tau), data = Tau, family = gaussian(link = "identity"), method = "REML")

AIC(Avg_lm, Avg_lm2, Avg_poly, Avg_log_re, Avg_gam)


AvgRes <- ggplot(data = Tau, aes(x = Tau, y = AvgRes))+
  geom_point()+
  xlab(expression(paste(tau, " (hrs)")))+
  ylab("Average resource use \n at 48 hours (OD590)")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  geom_smooth(method = "lm", formula = y ~ x, color = "blue", cex = 1.25, fill = alpha("black", 0.4))+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = "right")+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(Avg_lm)$r.sq, 2))))

AvgRes

ggsave("./output/RTLC_AvgRes.pdf")
ggsave("./output/RTLC_AvgRes.png", width = 6.5, height = 5)

```

#Draw figure
```{r}
ggdraw(plot_grid(P_IBM, BP_Tau))+
  draw_plot_label(label = c("IBM predictions", "Chemostat results"), size = 20, x = c(0,0.5), y = c(1,1))

ggsave("./output/CommBP.pdf")
ggsave("./output/CommBP.png", width = 10, height = 4)


ggdraw()+
  draw_plot(BP_Tau, x = 0, y = 0.55, width = 1, height = 0.45) + 
  draw_plot(AvgRes, x = 0, y = 0, width = 1, height = 0.55) + 
  draw_plot_label(label = c("A", "B"), size = 30, x = c(0.02,0.02), y = c(1,0.55))+
  theme(plot.background = element_rect(fill="white", color = NA))

ggsave("./output/Comm_Func.pdf")
ggsave("./output/Comm_Func.png", width = 8, height = 10)
```

#Figure 5. Community Function - Resource Use

#Bray-Curtis distance Resource use
```{r}
EcoPlate_20 <- EcoPlate[rownames(OTUsr_20),]
EP.db.20 <- vegdist(EcoPlate_20, method = "bray")
EP.db <-vegdist(EcoPlate, method = "bray")
EP.pcoa <- cmdscale(EP.db, eig = TRUE)

EPREL <- EcoPlate
for(i in 1:nrow(EcoPlate)){
  EPREL[i,] = EcoPlate[i,]/sum(EcoPlate[i,])
}

EP.pcoa <- add.spec.scores(EP.pcoa, EPREL, method = "pcoa.scores")

explainvar1.ep <- round(EP.pcoa$eig[1] / sum(EP.pcoa$eig), 3) * 100
explainvar2.ep <- round(EP.pcoa$eig[2] / sum(EP.pcoa$eig), 3) * 100
explainvar3.ep <- round(EP.pcoa$eig[3] / sum(EP.pcoa$eig), 3) * 100

types <- read.csv("data/RTLC/EcoPlate/Csourcetypes.csv", header = TRUE, sep = ",")

EP.plot <- as.data.frame(EP.pcoa$points)
EP.plot <- cbind(EP.plot, Tau$Tau, Tau$Turn, Tau$Pump)
colnames(EP.plot) <- c("V1", "V2", "Tau", "Turn", "Pump")
EP.plot$Turn <- factor(EP.plot$Turn, levels = c("TRUE", "FALSE"))
EP.plot$Pump <- factor(EP.plot$Pump, levels = c("TRUE", "FALSE"))

EP.cproj <- as.data.frame(EP.pcoa$cproj)
EP.cproj <- cbind(EP.cproj, as.data.frame(row.names(EP.pcoa$cproj)))
spe.corr.ep <- add.spec.scores(EP.pcoa, EPREL, method = "cor.scores")$cproj
spe.corr.ep <- as.data.frame(cbind(spe.corr.ep,types$Type))
corrcut.ep <- 0.75
imp.spp.ep <- as.data.frame(spe.corr.ep[abs(as.numeric(spe.corr.ep[,1])) >= corrcut.ep | abs(as.numeric(spe.corr.ep[,2])) >= corrcut.ep,])

Dim1.ep <- c()
Dim2.ep <- c()
for(x in unique(spe.corr.ep$V3)){
  Dim1.ep <- c(Dim1.ep, mean(as.numeric(subset(spe.corr.ep, spe.corr.ep$V3 == x)$Dim1)))
  Dim2.ep <- c(Dim2.ep, mean(as.numeric(subset(spe.corr.ep, spe.corr.ep$V3 == x)$Dim2)))
}

spe.corr.ep.means <- as.data.frame(unique(spe.corr.ep$V3))
spe.corr.ep.means <- cbind(spe.corr.ep.means, as.vector(Dim1.ep), as.vector(Dim2.ep))
colnames(spe.corr.ep.means) <- c("C_types", "Dim1", "Dim2")

fit <- envfit(EP.pcoa, EPREL, perm = 999)
fit

EP.plot$Tau <- as.numeric(EP.plot$Tau)
typeof(EP.plot$Tau)

EP_BC <- ggplot(EP.plot, aes(x = V1, y = V2, color = Turn))+
  geom_point(cex = 2)+
  xlab(paste("PCoA 1 (", explainvar1.ep, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2.ep, "%)", sep = ""))+
  xlim(c(-0.5, 0.3))+
  labs(color = "Number of turnovers")+
  theme(legend.position = "top", legend.title = element_text(size = 14))+
  scale_color_manual(values = c(alpha("blue", 0.3), alpha("black", 0.3)), labels = c("> 1", "< 1"))+
  geom_text(size = 5, data = spe.corr.ep.means, aes(x = Dim1, y = Dim2, label = C_types), color = "black")

EP_BC

ggsave("./output/RTLC_Res_BC_PCoA.pdf")
ggsave("./output/RTLC_Res_BC_PCoA.png", width = 8, height = 5)

EP_BC_turn <- ggplot(EP.plot, aes(x = V1, y = V2))+
  geom_point(cex = 3, aes(color = Pump, shape = Turn))+
  xlab(paste("PCoA 1 (", explainvar1.ep, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2.ep, "%)", sep = ""))+
  labs(shape = "Number of\nturnovers", color = "Treatment\nmethod")+
  scale_color_manual(values = c("blue", "black"), labels = c("Pump", "Manual"))+
  scale_shape_manual(values = c(19, 1), labels = c("> 1", "< 1"))+
  theme(legend.title = element_text(size = 14))

EP_BC_turn

ggsave("./output/RTLC_Res_BC_PCoA_turn.pdf")
ggsave("./output/RTLC_Res_BC_PCoA_turn.png", width = 8, height = 5)

EcoPlate_env$Set <- c(rep(1, 13), rep(2,12), rep(3,10), rep(4,14))

EP.dist <- vegdist(EcoPlate, method = "bray")
Env.dist <- vegdist(scale(EcoPlate_env[,-2]), method = "euclid")

mantel(EP.dist, Env.dist)

PC1_lm <- lm(V1 ~ Tau, data = EP.plot)
PC1_lm2 <- lm(V1 ~ Tau + Turn, data = EP.plot)
PC1_lm3 <- lm(V1 ~ Tau + Turn + Tau:Turn, data = EP.plot)
summary(PC1_lm3)

anova(PC1_lm, PC1_lm2, PC1_lm3)
AIC(PC1_lm, PC1_lm2, PC1_lm3)

Res_PCoA1 <- ggplot(EP.plot, aes(x = Tau, y = V1))+
  geom_point(cex = 2, aes(color = Turn))+
  ylab(paste("PCoA 1 (", explainvar1.ep, "%)\n", sep = ""))+
  xlab(expression(paste(tau, " (hrs)")))+
  labs(color = "Number of turnovers")+
  geom_smooth(method = "lm", formula = y~x, color = "blue", cex = 1.25, fill = alpha("black", 0.4))+
  scale_color_manual(values = c(alpha("blue", 0.3), alpha("black", 0.3)), labels = c("> 1", "< 1"))+
#  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
#               formula = y~x, parse = TRUE, size = 4)+
  theme(legend.position = "none")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(PC1_lm)$r.sq, 2))))

Res_PCoA1

ggsave("./output/RTLC_Res_BC_PCoA1.pdf")
ggsave("./output/RTLC_Res_BC_PCoA1.png", width = 6.5, height = 5)
```

##Draw Figure
```{r}
ggdraw()+
  draw_plot(EP_BC, x = 0, y = 0.45, width = 1, height = 0.55) + 
  draw_plot(Res_PCoA1, x = 0, y = 0, width = 1, height = 0.45) +
  theme(plot.background = element_rect(fill="white", color = NA))+
  draw_plot_label(label = c("A", "B"), size = 30, x = c(0,0), y = c(1, 0.45))

ggsave("./output/CommRes.pdf")
ggsave("./output/CommRes.png", width = 8, height = 10)
```

#Figure 6

```{r}
test.pw <- data.frame(site1=numeric(),
                        site2=numeric(), 
                        otupw=numeric(), 
                         ecopw=numeric())
rownames(EcoPlate) <- EcoPlate_env$Tau
x <- 2.5
y <- 3
for(x in row.names(OTUsr_20)){
  for(y in row.names(OTUsr_20)){
    test.pw <- rbind(test.pw, c(x, y, vegdist(OTUsr_20[c(x,y),], method = "bray", upper = TRUE, diag = TRUE)[1], vegdist(EcoPlate[c(x,y),], method = "euclidean", upper = TRUE, diag = TRUE)[1]))
  }
}

colnames(test.pw) <- c("site1", "site2", "otupw", "ecopw")
test.pw$site1 <- as.numeric(test.pw$site1)
test.pw$site1 <- log(((10^test.pw$site1)/60), 10)
test.pw$site2 <- as.numeric(test.pw$site2)
test.pw$site2 <- log(((10^test.pw$site2)/60), 10)
test.pw$otupw <- as.numeric(test.pw$otupw)
test.pw$ecopw <- as.numeric(test.pw$ecopw)
test.pw$taudiff <- test.pw$site2 - test.pw$site1
test.pw[1, "site1"]
for(row in row(test.pw)){
  if((test.pw[row, "site1"] > 2.6 && test.pw[row, "site2"] > 2.6)){
    test.pw[row, "Turn"] <- "Less"
  }
  else if((test.pw[row, "site1"] < 2.6 && test.pw[row, "site2"] < 2.6)){
    test.pw[row, "Turn"] <- "More"
  }
  else{
    test.pw[row, "Turn"] <- NA
  }
}

pw_lm <- lm(otupw ~ ecopw * Turn, data = subset(test.pw, is.na(test.pw$Turn) == FALSE))
AIC(pw_lm)
summary(pw_lm)
anova
mantel(tau.db, EP.db.20)


pw.bc <- ggplot(data = subset(test.pw, is.na(test.pw$Turn) == FALSE), aes(x = ecopw, y = otupw, group = Turn))+
  geom_point(aes(color = Turn))+
  xlab("Resource use distance")+
  ylab("Community distance")+
  scale_color_manual(values = c(alpha("green",0.3), alpha("#FC0FC0", 0.3)), labels = c("No", "Yes"))+
  labs(color = "Full Turnover")+
  geom_smooth(method = "lm", formula = y ~ x, color = "blue", cex = 1.25, fill = alpha("black", 0.4))+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = "right", label.y= "bottom")

pw.bc

ggsave("./output/RTLC_BC_PW.pdf")
ggsave("./output/RTLC_BC_PW.png")
```


#Unused figures - Non-sequence based


##Individual Productivity (uM C/hr/Cell)
```{r}
IP_lm <- lm(ind_P ~ Tau, data = Tau)
IP_lm_2 <- lm(log(ind_P, 10) ~ poly(Tau, 2, raw = TRUE), data = Tau)
IP_exp <- lm(log(ind_P, 10) ~ Tau, data = Tau)
summary(IP_lm)
summary(IP_lm_2)
summary(IP_exp)
AIC(IP_lm)
AIC(IP_lm_2)
AIC(IP_exp)
plot(IP_lm_2)
plot(IP_lm)
plot(IP_exp)

IP <- ggplot(Tau, aes(x = Tau, y = log(ind_P, 10)))+
  geom_point(size = 2, alpha = 0.6)+
  xlab(expression(paste(tau, " (mins)")))+
  ylab(expression(atop("Biomass Production", paste("(", mu, "M C/hr/Cell)"))))+
  geom_smooth(method = "lm", formula = y ~ poly(x, 2, raw = TRUE))+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               label.x = "right", label.y = "top", formula = y ~ poly(x, 2, raw = TRUE), parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(N_gam_re)$r.sq, 3))))

IP

ggsave("./output/RTLC_IP.pdf")
ggsave("./output/RTLC_IP.png")

```

##Biofilm Formation
```{r}

OT_N_re <- lmer(log(OT/N) ~ Tau + (1|Set), data = Tau)
OT_N <- lm(log(OT/N) ~ Tau, data = Tau)

summary(OT_N_re)
summary(OT_N)
AIC(OT_N, OT_N_re)
anova(OT_N_re, OT_N)


Sig <- car::Anova(OT_N_re, test.statistic = "F")

OT_Tau <- ggplot(Tau, aes(x = Tau, y = log(OT/N)))+
  geom_point(size = 2, alpha = 0.6)+
  xlab(expression(paste(tau, " (mins)")))+
  ylab("log(Biofilm Formation/Cell) \n OD 595 nm")+
  geom_smooth(method = "lm")+
  labs(title = paste(" P =", Sig$`Pr(>F)`[1]))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(N_gam_re)$r.sq, 3))))

OT_Tau

ggsave("./output/RTLC_OT.pdf")
ggsave("./output/RTLC_OT.png")
```

##Load Resource Use data for first 72 hours
```{r}
EcoPlate_72 <- read.csv("data/RTLC/eco.data_rt_S1_0.txt", header = TRUE, sep = "\t")
file_list <- c("data/RTLC/eco.data_rt_S1_24.txt", "data/RTLC/eco.data_rt_S1_48.txt", "data/RTLC/eco.data_rt_S1_72.txt", "data/RTLC/eco.data_rt_S2_0.txt", "data/RTLC/eco.data_rt_S2_24.txt", "data/RTLC/eco.data_rt_S2_48.txt", "data/RTLC/eco.data_rt_S2_72.txt", "data/RTLC/eco.data_rt_S3_0.txt", "data/RTLC/eco.data_rt_S3_24.txt", "data/RTLC/eco.data_rt_S3_48.txt", "data/RTLC/eco.data_rt_S3_72.txt", "data/RTLC/eco.data_rt_S4_0.txt", "data/RTLC/eco.data_rt_S4_24.txt", "data/RTLC/eco.data_rt_S4_48.txt", "data/RTLC/eco.data_rt_S4_72.txt")

for(file in file_list){
  EcoPlate_72 <- rbind(EcoPlate_72, read.csv(file, header = TRUE, sep = "\t"))
}

long_EP <- EcoPlate_72 %>% gather(C_Source, OD, X2.Hydroxy.Benzoic.Acid:Avg)
```

##Load slopes of resource use data (48-24 hours)
```{r}
EcoPlate_S1 <- read.csv("data/RTLC/eco.data_rt_S1_48.txt", header = TRUE, sep = "\t")
EcoPlate_S1 <- cbind(EcoPlate_S1[,1:2], (EcoPlate_S1[,4:34] - read.csv("data/RTLC/eco.data_rt_S1_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S1[,4:33] <- EcoPlate_S1[,4:33]/48

EcoPlate_S2 <- read.csv("data/RTLC/eco.data_rt_S2_48.txt", header = TRUE, sep = "\t")
EcoPlate_S2 <- cbind(EcoPlate_S2[,1:2], (EcoPlate_S2[,4:34] - read.csv("data/RTLC/eco.data_rt_S2_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S2[,4:33] <- EcoPlate_S2[,4:33]/48

EcoPlate_S3 <- read.csv("data/RTLC/eco.data_rt_S3_48.txt", header = TRUE, sep = "\t")
EcoPlate_S3 <- cbind(EcoPlate_S3[,1:2], (EcoPlate_S3[,4:34] - read.csv("data/RTLC/eco.data_rt_S3_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S3[,4:33] <- EcoPlate_S3[,4:33]/48

EcoPlate_S4 <- read.csv("data/RTLC/eco.data_rt_S4_48.txt", header = TRUE, sep = "\t")
EcoPlate_S4 <- cbind(EcoPlate_S4[,1:2], (EcoPlate_S4[,4:34] - read.csv("data/RTLC/eco.data_rt_S4_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S4[,4:33] <- EcoPlate_S4[,4:33]/48

EcoPlate_Slope <- rbind(EcoPlate_S1, EcoPlate_S2, EcoPlate_S3, EcoPlate_S4)

ResType <- read.csv("code/resource_type.txt", header = TRUE, sep = "\t")

colnames(EcoPlate_Slope) <- c("Tau", "Set", "2-Hydroxy.Benzoic.Acid", "4-Hydroxy.Benzoic.Acid", "alpha-Cyclodextrin", "alpha-D-Lactose", "alpha-Ketobutyric.Acid", "beta-Methyl-D-Glucoside", "D-Cellobiose", "D-Galactonic.Acid.gamma-Lactone", "D-Galacturonic.Acid","D-Glucosaminic.Acid", "D-Malic.Acid", "D-Mannitol", "D-Xylose", "D,L-alpha-Glycerol.Phosphate","gamma-Hydroxybutyric.Acid", "Glucose-1-Phosphate", "Glycogen", "Glycyl-L-Glutamic.Acid", "i-Erythritol","Itaconic.Acid","L-Arginine", "L-Asparagine","L-Phenylalanine", "L-Serine", "L-Threonine","N-Acetyl-D-Glucosamine", "Phenylethylamine", "Putrescine", "Pyruvic.Acid.Methyl.Ester", "Tween.40", "Tween.80")


long_EP_slope <- EcoPlate_Slope %>% gather(C_Source, Slope, "2-Hydroxy.Benzoic.Acid":"Tween.80")

ResType <- distinct(ResType)

long_EP_slope$Type <- NA

for(row in rownames(long_EP_slope)){
  long_EP_slope[row,"Type"] <- ResType$Type[ResType$Resource == long_EP_slope[row,"C_Source"]]
}


```


##Total number of resources used at 48 hours
```{r}
NR_lm <- lm(NumRes ~ Tau, data = Tau)
NR_lm_re <- lmer(NumRes ~ Tau + (1|Set), data = Tau)
NR_lm_2 <- lm(NumRes ~ poly(Tau, 2, raw = TRUE), data = Tau)
summary(NR_lm)
AIC(NR_lm)
AIC(NR_lm_2)

anova(NR_lm_re, NR_lm_2, NR_lm)

NumRes <- ggplot(Tau, aes(x = Tau, y = NumRes))+
  geom_point(size = 2, alpha = 0.6)+
  ylim(c(20, 33))+
  xlab(expression(paste(tau, " (mins)")))+
  ylab("Number of Resources Used \n at 48 hours")+
  geom_smooth(method = "lm", formula = y~x, color = "blue", fill = alpha("black", 0.4))+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))


NumRes

ggsave("./output/RTLC_NumRes.pdf")
ggsave("./output/RTLC_NumRes.png")
```


##Plot resource use vs. Time for all Tau

```{r}
Avg_Hr <- ggplot(subset(long_EP, long_EP$C_Source =="Avg"), aes(x = Hours, y = OD, group = Tau, color = Tau))+
  geom_line(size = 1)+
  geom_point(size = 3)+
  xlab("Hours")+
  ylab("Average Well Response (OD590)")+
  labs(group = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))
  
Avg_Hr

ggsave("./output/RTLC_AvgRes_Hr.pdf")
ggsave("./output/RTLC_AvgRes_Hr.png")

```

#Euclidean distance Resource use
```{r}
EP.eu <-vegdist(EcoPlate, method = "euclidean")
EP.pca <- cmdscale(EP.eu, eig = TRUE)
EP.pca <- add.spec.scores(EP.pca, EcoPlate, method = "pcoa.scores")

explainvar1 <- round(EP.pca$eig[1] / sum(EP.pca$eig), 3) * 100
explainvar2 <- round(EP.pca$eig[2] / sum(EP.pca$eig), 3) * 100
explainvar3 <- round(EP.pca$eig[3] / sum(EP.pca$eig), 3) * 100

EP.plot <- as.data.frame(EP.pca$points)
EP.plot <- cbind(EP.plot, Tau$Tau, Tau$Turn)
colnames(EP.plot) <- c("V1", "V2", "Tau", "Turn")
EP.cproj <- as.data.frame(EP.pca$cproj)
EP.cproj <- cbind(EP.cproj, as.data.frame(row.names(EP.pca$cproj)))

EP_EU <- ggplot(EP.plot, aes(x = V1, y = V2, colour = Turn))+
  geom_point(cex = 3)+
  xlab(paste("PCA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = "Full Turnover")+
  scale_color_manual(values = c(alpha("green",0.3), alpha("#FC0FC0", 0.3)), labels = c("No", "Yes"))+
  theme(legend.title = element_text(size = 16))


EP_EU

ggsave("./output/RTLC_Res_Eu_PCA.pdf")
ggsave("./output/RTLC_Res_Eu_PCA.png")


PC1_lm <- lm(V1 ~ Tau, data = EP.plot)
summary(PC1_lm)

PC1 <- ggplot(EP.plot, aes(x = Tau, y = V1))+
  geom_point(pch = 19, cex = 3)+
  ylab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  xlab(expression(tau))+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

PC1

ggsave("./output/RTLC_Res_Eu_PCA1.pdf")
ggsave("./output/RTLC_Res_Eu_PCA1.png")

PC2_lm <- lm(V2 ~ Tau, data = EP.plot)
summary(PC2_lm)

PC2 <- ggplot(EP.plot, aes(x = Tau, y = V2))+
  geom_point(pch=19, cex = 3)+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  xlab(expression(tau))+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

PC2

ggsave("./output/RTLC_Res_Eu_PCA2.pdf")
ggsave("./output/RTLC_Res_Eu_PCA2.png")

```


PCoA Resource Use - PC2
```{r}
PC2_lm <- lm(V2 ~ Turn, data = EP.plot)
PC2_lm <- lm(V2 ~ Tau, data = EP.plot)
PC2_lm2 <- lm(V2 ~ Tau + Turn, data = EP.plot)
PC2_lm3 <- lm(V2 ~ Tau + Turn + Tau:Turn, data = EP.plot)
summary(PC1_lm3)

anova(PC2_lm, PC2_lm2, PC2_lm3)
AIC(PC2_lm, PC2_lm2, PC2_lm3)
anova(PC2_lm, PC2_lm2)
summary(PC2_lm)

PC2 <- ggplot(EP.plot, aes(x = Tau, y = V2, group = Turn))+
  geom_point(pch=19, cex = 3)+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  xlab(expression(tau))+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

PC2

ggsave("./output/RTLC_Res_BC_PCoA2.pdf")
ggsave("./output/RTLC_Res_BC_PCoA2.png")
```


```{r}

lm.slope.tau <- lm(data = long_EP_slope, Slope ~ Tau)
summary(lm.slope.tau)
lm.slope.tau.c <- lm(data = long_EP_slope, Slope ~ Tau * C_Source)
summary(lm.slope.tau.c)

anova(lm.slope.tau)

anova(lm.slope.tau, lm.slope.tau.c)
AIC(lm.slope.tau)
AIC(lm.slope.tau.c)

histogram(log(long_EP_slope$Slope, 10))

plot(lm.slope.tau.c)

Res_Slope <- ggplot(long_EP_slope, aes(x = Tau, y = Slope, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  xlab(expression(tau))+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
      formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  theme(legend.position="bottom")

Res_Slope
```

```{r}
Res_heat <- as.data.frame(colnames(EcoPlate))
colnames(Res_heat) <- c("Res")
Res_heat$N <- colSums(EcoPlate)
rownames(EcoPlate) <- c(EcoPlate_env$Tau)
 

for (res in Res_heat$Res){
  x = 0
  for(site in rownames(EcoPlate)){
    x = x + (EcoPlate[site, res] * as.numeric(site))
  }
  Res_heat$Tau[Res_heat$Res == res] <- x/Res_heat$N[Res_heat$Res == res]
}

colnames(Res_heat) <- c("Res", "N", "Weight")

Res_heat <- Res_heat[order(Res_heat$Weight),]

EcoPlate <- cbind(EcoPlate_env, EcoPlate)

colnames(EcoPlate)

#########
eco_long <- gather(EcoPlate, Res, N, X2.Hydroxy.Benzoic.Acid:Tween.80, factor_key = TRUE)
eco_long$Res <- factor(eco_long$Res, levels = rev(as.list(Res_heat$Res)))
print(levels(eco_long$Res))

eco_long$Tau <- as.factor(eco_long$Tau)

ecoplate_heat <- ggplot(eco_long, aes(Tau, Res, fill = N))+
  geom_tile()+
  theme(axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_blank(), axis.text.y = element_text(size = 10))+
  scale_fill_continuous(type = "viridis")

ecoplate_heat

ggsave("./output/res_heatmap.pdf")
ggsave("./output/res_heatmap.png")
```

##Bray-Curtis axes vs. Tau
```{r}


install.packages("ecotraj")
library("ecotraj")

oldpar <- par(mar=c(4,4,1,1))
trajectoryPCoA(tau.db, sites = c(rep(1, 35)), surveys = tau.plot$Tau, traj.colors = c("black"), lwd = 2, survey.labels = F, selection = 1)
trajectoryLengths(tau.db, sites = c(rep(1, 35)), surveys = tau.plot$Tau)
```

```{r}
summary(lm.slope.tau)$coefficients[2,4]
summary(lm.slope.tau)$coefficients

csource_sig <- c()
for(x in unique(long_EP_slope$C_Source)){
  csource.lm <- lm(data = subset(long_EP_slope, long_EP_slope$C_Source == x), Slope ~ Tau)
  if(summary(csource.lm)$coefficients[2,4] < (0.05/31)){
    print(unique(subset(long_EP_slope, long_EP_slope$C_Source == x)$Type))
    print(summary(csource.lm)$coefficients[2,1])
    csource_sig <- c(csource_sig, x)
  }
}

Csource_sig <- ggplot(data = long_EP_slope[long_EP_slope$C_Source %in% csource_sig,], aes(x = Tau, y = Slope, group = C_Source, color = C_Source))+
  geom_point(size = 3)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label = paste(stat(rr.label), "*\", \"*", stat(p.value.label), sep = "")),
              formula = y~x, parse = TRUE, size = 4, p.digits = 4, label.x = 0.9, label.y = c(0.95, 0.9, 0.85, 0.95, 0.95, 0.9, 0.85, 0.8, 0.95, 0.95, 0.95, 0.9))+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Carbon source use per day (OD600)")+
  labs(color = "Carbon Source")+
  theme(legend.position=NULL)+
  facet_wrap(~Type, ncol = 2, nrow = 3)

  
Csource_sig

ggsave("./output/RTLC_Res_Csource_sig.pdf", width = 15, height =15)
ggsave("./output/RTLC_Res_Csource_sig.png", width = 15, height = 15)
  
```





##Ester
```{r}
Res_Slope_Ester <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "ester"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Ester")+
  theme(legend.position="bottom")

  
Res_Slope_Ester

ggsave("./output/RTLC_Res_Slope_ester.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_ester.png", width = 10, height = 8)
```

##Carboxylic Acid 1
```{r}
Res_Slope_CarAc <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "carboxylic acid"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Carboxylic Acid")+
  theme(legend.position="bottom")
  
Res_Slope_CarAc

ggsave("./output/RTLC_Res_Slope_CarAc.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_CarAc.png", width = 10, height = 8)
```

##Carboxylic Acid 2
```{r}
Res_Slope_CarAc_2 <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "carboxylic acid" & long_EP_slope$C_Source != "2-Hydroxy.Benzoic.Acid"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Carboxylic Acid")+
  theme(legend.position="bottom")
  
Res_Slope_CarAc_2

ggsave("./output/RTLC_Res_Slope_CarAc_2.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_CarAc_2.png", width = 10, height = 8)
```

##Carbohydrate
```{r}
Res_Slope_carbo <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "carbohydrate"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Carbohydrate")+
  theme(legend.position="bottom")
  
Res_Slope_carbo

ggsave("./output/RTLC_Res_Slope_Carbo.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_Carbo.png", width = 10, height = 8)
```

##Phosphorylated
```{r}
phos.lm <- lm(data = subset(long_EP_slope, long_EP_slope$Type == "phosphorylated"), Slope ~ Tau + C_Source)
phos.lm <- lm(data = subset(long_EP_slope, long_EP_slope$C_Source == "Glucose-1-Phosphate"), Slope ~ Tau)
summary(phos.lm)

Res_Slope_phos <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "phosphorylated"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Phosphorylated")+
  theme(legend.position="bottom")
  
Res_Slope_phos

ggsave("./output/RTLC_Res_Slope_phos.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_phos.png", width = 10, height = 8)
```
#Amino Acid
```{r}
Res_Slope_aa <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "amino acid"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Amino Acid")+
  theme(legend.position="bottom")
  
Res_Slope_aa

ggsave("./output/RTLC_Res_Slope_aa.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_aa.png", width = 10, height = 8)
```
#Amine
```{r}
Res_Slope_am <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "amine"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Amine")+
  theme(legend.position="bottom")
  
Res_Slope_am

ggsave("./output/RTLC_Res_Slope_am.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_am.png", width = 10, height = 8)
```

##Polymer
```{r}
Res_Slope_poly <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "polymer"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "loess", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Polymer")+
  theme(legend.position="bottom")
  
Res_Slope_poly

ggsave("./output/RTLC_Res_Slope_Poly.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_Poly.png", width = 10, height = 8)
```

#Unused figures - Sequence Based
##Proportional species turnover
```{r}
#Beta = (gamma - alpha)/gamma
Beta_pro <- function(site = ""){
  print(site)
  if (is.na(site)){
    return(NA)
  }
  else{
    site <- t(OTUs.PA[site,])
    site <- as.data.frame(subset(site, select = site > 0))
  #Proportional species turnover
    b <- (gamma - ncol(site))/gamma
    print(b)
    return(b)
  }
}

Tau$Day_0_Seq <- as.character(Tau$Day_0_Seq)
Tau$Day_20_Seq <- as.character(Tau$Day_20_Seq)

Tau$Beta_pro <- NA
row <- 1
while(row <= nrow(Tau)){
  Tau[row, "Beta_pro"] <- Beta_pro(Tau[row, "Day_20_Seq"])
  row = row + 1
}

Bpro_lm <- lm(Beta_pro ~ Tau, data = Tau)
Bpro_poly <- lm(Beta_pro ~ poly(Tau, 2, raw = TRUE), data = Tau)
Bpro_gam <- gam(Beta_pro ~ s(Tau), family = gaussian(link = "identity"), data = Tau, method = "REML")

AIC(Bpro_lm, Bpro_poly, Bpro_gam)

Bpro_gam_re <- gam(Beta_pro ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")
Bpro_gam_re_sp <- gam(Beta_pro ~ s(Tau, sp = 0.2) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

anova(Bpro_gam, Bpro_gam_re, test = "Chisq")

summary(Bpro_gam_re)
k.check(Bpro_gam_re)
gam.check(Bpro_gam_re)


beta_pro <- predict_gam(Bpro_gam_re_sp, exclude_terms = "s(Set)") %>%
  filter(Set == "1") %>% 
  ggplot(aes(Tau, fit))+
  geom_smooth_ci(color = "blue", cex = 1.25, ci_alpha = 0.4)+
  geom_point(data = Tau, aes(x = Tau, y = Beta_pro), size = 2, alpha = 0.6)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau, " (mins)")))+
  ylab(expression(paste(beta == (gamma-alpha)/gamma)))+
  labs(title = bquote("R"^2~ "=" ~ .(signif(summary(S_gam_re_sp)$r.sq, 3))))
  
beta_pro

ggsave("./output/RTLC_Bpro.pdf")
ggsave("./output/RTLC_Bpro.png")
```

##Generate heat map of Day 20 communities with BC distance
```{r}
OTUsr_20_or <- OTUsr_20[order(rownames(OTUsr_20)),]

tau.db <- vegdist(OTUsr_20_or, method = "bray", upper = TRUE, diag = TRUE)
order <- rev(attr(tau.db, "Labels"))

pdf(file = "./output/RTLC_BC_heat.pdf")
jpeg(file = "./output/RTLC_BC_heat.jpeg")
levelplot(as.matrix(tau.db) [, order], aspect = "iso", col.regions = inferno, xlab = "log(Tau, 10)", ylab = "log(Tau, 10)", scales = list(x=list(at=seq(1,49,1), labels = c("1.5", rep("",2) , "2.5", rep("",4),  "3.5", rep("", 3),"4", rep("", 2), "4.5", rep("",4), "5.25", rep("", 3), "6", rep("", 5), "7", rep("", 3), "8")), y=list(at=seq(1,49,1), labels = rev(c("1.5", rep("",2) , "2.5", rep("",4),  "3.5", rep("", 3),"4", rep("", 2), "4.5", rep("",4), "5.25", rep("", 3), "6", rep("", 5), "7", rep("", 3), "8")))), main = "Bray-Curtis Distance")
dev.off()
```

##Want OTUs by pH of site heat map to show horseshoe
```{r}
OTU_r_trim <- OTU_r[1:69,]
OTU_heat <- as.data.frame(colnames(OTU_r_trim))
colnames(OTU_heat) <- c("OTU")
OTU_heat$N <- colSums(OTU_r_trim)
 

for (otu in OTU_heat$OTU){
  x = 0
  for(site in rownames(OTU_r_trim)){
    x = x + (OTU_r_trim[site, otu] * Tau_Seq$Tau[Tau_Seq$Seq_Sample == site])
  }
  OTU_heat$Tau[OTU_heat$OTU == otu] <- x/OTU_heat$N[OTU_heat$OTU == otu]
}

OTU_heat <- OTU_heat[order(OTU_heat$Tau),]

OTU_heat <- OTU_heat[order(OTU_heat$Weight),]

colnames(OTU_heat) <- c("OTU", "N", "Weight")

OTU_heat <- cbind(OTU_heat, Tau_Seq[1:69,"Tau"])

plot(x = as.numeric(OTUsr_20$Tau), y = OTUsr_20$Otu00628)
#########

colnames(OTUsr_20)[1] <- c("Tau")
data_long <- gather(OTUsr_20, OTU, N, Otu00001:Otu33565, factor_key = TRUE)
data_long$OTU <- factor(data_long$OTU, levels = rev(as.list(OTU_heat$OTU)))
print(levels(data_long$OTU))

map <- ggplot(data_long, aes(Tau, OTU, fill = log(N, 10)))+
  geom_tile()+
  theme(axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())+
  scale_fill_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))

map

ggsave("./output/map.pdf")
ggsave("./output/map.png")

```

##Generate PCoA of all samples using BC distance
```{r}
tau_all.db <- vegdist(OTU_r[1:69,], method = "bray", upper = TRUE, diag = TRUE)

tau.pcoa <- cmdscale(tau_all.db, eig = TRUE, k = 3)
explainvar1 <- round(tau.pcoa$eig[1] / sum(tau.pcoa$eig), 3) *100
explainvar2 <- round(tau.pcoa$eig[2] / sum(tau.pcoa$eig), 3) *100
explainvar3 <- round(tau.pcoa$eig[3] / sum(tau.pcoa$eig), 3) *100
sum.eig <- sum(explainvar3, explainvar2, explainvar1)

tau.plot <- as.data.frame(tau.pcoa$points)
tau.plot <- cbind(tau.plot, Tau_Seq[1:69,])
spe.corr <- add.spec.scores(tau.pcoa, OTU_r[1:69,], method = "cor.scores")$cproj
corrcut <- 0.8
imp.spp <- as.data.frame(spe.corr[abs(spe.corr[,1]) >= corrcut | abs(spe.corr[,2]) >= corrcut,])
imp.spp <- na.omit(imp.spp)

imp.tax <- subset(OTU.tax, OTU == rownames(imp.spp)[1])

x <- 2                        
while (x <= nrow(imp.spp)){
  imp.tax <- rbind(imp.tax, subset(OTU.tax, OTU == rownames(imp.spp)[x]))
  x <- x + 1
}

imp.spp <- cbind(imp.spp, imp.tax)
imp.spp.tau <- subset(imp.spp, imp.spp$Dim2 > 0.5)

names <- unique(rownames(imp.spp.tau))

for (x in names){
  plot(Tau_Seq$Tau, OTUsREL[, x])
}


PCoA_all <- ggplot(tau.plot, aes(x = V1, y = V2))+
  geom_point(cex = 3, aes(colour = as.numeric(Tau), shape = Day))+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = expression(paste(tau, " (mins)")))+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))+
  scale_shape_manual(values = c(1,19))
#  geom_text(data = imp.spp, aes(x = Dim1, y = Dim2, label = Class))

PCoA_all

ggsave("./output/RTLC_BC_PCoA_all.pdf")
ggsave("./output/RTLC_BC_PCoA_all.png")

PCoA_all_20 <- ggplot(subset(tau.plot, tau.plot$Day == "20"), aes(x = V1, y = V2))+
  geom_point(cex = 3, aes(colour = as.numeric(Tau)))+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = expression(paste(tau, " (mins)")))+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))
#  scale_shape_manual(values = c(1,19))
  geom_text(data = imp.spp, aes(x = Dim1, y = Dim2, label = Class))

PCoA_all_20

ggsave("./output/RTLC_BC_PCoA_all_20.pdf")
ggsave("./output/RTLC_BC_PCoA_all_20.png")


PC1 <- ggplot(subset(tau.plot, tau.plot$Day == "20"), aes(x = Tau, y = V1))+
    geom_point(cex = 3)+
    ylab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
    xlab(expression(paste(tau, " (mins)")))

PC1

ggsave("./output/RTLC_BC_PC1_all.pdf")
ggsave("./output/RTLC_BC_PC1_all.png")

PC2 <- ggplot(subset(tau.plot, tau.plot$Day == "20"), aes(x = Tau, y = V2))+
    geom_point(cex = 3)+
    ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
    xlab(expression(paste(tau, " (mins)")))+
    scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

PC2

ggsave("./output/RTLC_BC_PC2_all.pdf")
ggsave("./output/RTLC_BC_PC2_all.png")

#fit <- envfit(tau.pcoa, OTUsREL_20, perm = 999)
```
    
##Species Turnover (Whittaker's Turnover between two sites)
```{r}
#Betaw = (S1 - gamma) + (S2 - gamma)/mean(S1, S2)
Betaw <- function(site1 = "", site2 = ""){
  site1 <- t(OTUs.PA[site1,])
  site2 <- t(OTUs.PA[site2,])
  site1 <- as.data.frame(subset(site1, select = site1 > 0))
  site2 <- as.data.frame(subset(site2, select = site2 > 0))
  gamma <- as.numeric(length(intersect(colnames(site1), colnames(site2))))
  bw <- ((ncol(site1) - gamma) + (ncol(site2) - gamma))/mean(ncol(site1), ncol(site2))
  return(bw)
}

Tau$Betaw <- NA
row <- 1
while(row < nrow(Tau)){
  if(!is.na(Tau[row, "Day_0_Seq"]) && !is.na(Tau[row, "Day_20_Seq"])){
    Tau[row, "Betaw"] <- Betaw(Tau[row, "Day_0_Seq"], Tau[row, "Day_20_Seq"])
  }
  row = row + 1
}

Bw_lm <- lm(Betaw ~ Tau, data = Tau)
Bw_poly <- lm(Betaw ~ poly(Tau, 2, raw = TRUE), data = Tau)
Bw_gam <- gam(Betaw ~ s(Tau), family = gaussian(link = "identity"), data = Tau, method = "REML")
Bw_gam_re <- gam(Betaw ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

AIC(Bw_lm, Bw_poly, Bw_gam, Bw_gam_re)
anova(Bw_lm, Bw_poly, Bw_gam, Bw_gam_re)

summary(Bw_lm)
summary(Bw_poly)
summary(Bw_gam)
summary(Bw_gam_re)

k.check(Bw_gam)
k.check(Bw_gam_re)
gam.check(Bw_gam)
gam.check(Bw_gam_re)

betaw <- ggplot(data = Tau, aes(x = Tau, y = Betaw))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  geom_smooth(method = "lm", formula = y ~ poly(x, 2, raw = TRUE))+
  xlab(expression(paste(tau, " (mins)")))+
  stat_poly_eq(aes(label = paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
            label.x = "left", label.y = "top", formula = y~poly(x, 2, raw = TRUE), parse = TRUE, size = 4)+
  ylab(expression(beta[W]))
  
betaw

ggsave("./output/RTLC_Bw.pdf")
ggsave("./output/RTLC_Bw.png")
```

#Whittaker's species turnover
```{r}
#Beta = (gamma - alpha)/alpha
Beta <- function(site = ""){
  if (is.na(site)){
    return(NA)
  }
  else{
    site <- t(OTUs.PA[site,])  
    site <- as.data.frame(subset(site, select = site > 0))
  #Whittaker's species turnover
    b <- (gamma- ncol(site))/(ncol(site))
    return(b)
  }
}

Tau$Beta <- NA
row <- 1
while(row <= nrow(Tau)){
  Tau[row, "Beta"] <- Beta(Tau[row, "Day_20_Seq"])
  row = row + 1
}

B_lm <- lm(Beta ~ Tau, data = Tau)
B_poly <- lm(Beta ~ poly(Tau, 2, raw = TRUE), data = Tau)
B_gam <- gam(Beta ~ s(Tau), family = gaussian(link = "identity"), data = Tau, method = "REML")
B_gam_re <- gam(Beta ~ s(Tau) + s(Set, bs = "re"), family = gaussian(link = "identity"), data = Tau, method = "REML")

AIC(B_lm, B_poly, B_gam, B_gam_re)
anova(B_lm, B_poly, B_gam, B_gam_re)

summary(B_lm)
summary(B_poly)
summary(B_gam)
summary(B_gam_re)

k.check(B_gam)
k.check(B_gam_re)
gam.check(B_gam)
gam.check(B_gam_re)

beta <- ggplot(data = Tau, aes(x = Tau, y = Beta))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau, " (mins)")))+
  ylab(expression(paste(beta == (gamma-alpha)/alpha)))+
  geom_smooth(method = "gam", formula = y ~ s(x), method.args=list(family = gaussian(link = "identity")), level = 0.95)
  
beta

ggsave("./output/RTLC_B.pdf")
ggsave("./output/RTLC_B.png")
```


#Pairwise Bray-Curtis
```{r}
Betabc <- function(site1 = "", site2 = ""){
  site1 <- t(OTUsREL[site1,])
  site2 <- t(OTUsREL[site2,])
  sites <- rbind(site1, site2)
  remove <- c()
  col <- 1
  while(col < ncol(OTUsREL)){
    if(sites[1, col] == 0 && sites[1, col] == 0){
     remove <- cbind(remove, col)
    }
   col <- col + 1
  }
  sites <- sites[,-remove]
  
  return(as.numeric(vegdist(sites, method = "bray")))
}

Tau$Betabc <- NA
row <- 1
while(row < nrow(Tau)){
  if(Tau[row, "Day_0_Seq"] != "" && Tau[row, "Day_20_Seq"] != ""){
    Tau[row, "Betabc"] <- Betabc(Tau[row, "Day_0_Seq"], Tau[row, "Day_20_Seq"])
  }
  row = row + 1
}

betabc <- ggplot(data = Tau, aes(x = Tau, y = Betabc))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau, " (mins)")))+
  ylab("BC (Bray-Curtis Dissimilarity)")
  
betabc

ggsave("./output/RTLC_Bbc_Tau.pdf")
ggsave("./output/RTLC_Bbc_Tau.png")
```



#Unused Plots - IBMs

```{r}
#IBM <- read.csv("data/IBM/SimData.csv", header = TRUE, sep = ",")

#IBM_2 <- subset(IBM, log(IBM$V, 10) <= 2 & log(IBM$V, 10) > 1)
#IBM_sum <- as.data.frame(unique(IBM_2$sim))
#colnames(IBM_sum) <- c("sim")

#for(x in unique(IBM_sum$sim)){
#  IBM_sum[IBM_sum$sim == x, "N"] <- mean(subset(IBM_2, IBM_2$sim == x)$total.abundance)
#  IBM_sum[IBM_sum$sim == x, "V"] <- mean(subset(IBM_2, IBM_2$sim == x)$V)
#  IBM_sum[IBM_sum$sim == x, "Q"] <- mean(subset(IBM_2, IBM_2$sim == x)$Q)
#  IBM_sum[IBM_sum$sim == x, "S"] <- mean(subset(IBM_2, IBM_2$sim == x)$species.richness)
#  IBM_sum[IBM_sum$sim == x, "E"] <- mean(subset(IBM_2, IBM_2$sim == x)$simpson.e, na.rm = TRUE)
#  IBM_sum[IBM_sum$sim == x, "P"] <- mean(subset(IBM_2, IBM_2$sim == x)$ind.production, na.rm = TRUE)
#  IBM_sum[IBM_sum$sim == x, "B"] <- mean(subset(IBM_2, IBM_2$sim == x)$whittakers.turnover, na.rm = TRUE)
#  IBM_sum[IBM_sum$sim == x, "Res"] <- mean(subset(IBM_2, IBM_2$sim == x)$avg.per.capita.efficiency1e, na.rm = TRUE)
#}

#write.csv(IBM_sum, "data/IBM/IBM_sum.csv", row.names = FALSE)

IBM_sum <- read.csv("data/IBM/IBM_sum.csv", header = TRUE, sep = ",")
```

```{r}
N_IBM <- ggplot(data = subset(IBM_sum, log(IBM_sum$V, 10) <= 2 & log(IBM_sum$V, 10) > 1), aes(y = log(N, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(1, 5))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Total abundance, ", italic("N"))))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

N_IBM


ggsave("./output/IBM_N.pdf")
ggsave("./output/IBM_N.png", width = 6.5, height = 5)


S_IBM <- ggplot(data = subset(IBM_sum, log(IBM_sum$V, 10) <= 2 & log(IBM_sum$V, 10) > 1), aes(y = log(S, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(1, 5))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(0, 1.5))+
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Species richness, ", italic("S"))))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

S_IBM

ggsave("./output/IBM_S.pdf")
ggsave("./output/IBM_S.png", width = 6.5, height = 5)


E_IBM <- ggplot(data = subset(IBM_sum, log(IBM_sum$V, 10) <= 2 & log(IBM_sum$V, 10) > 1), aes(y = log(E, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(1, 5))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-0.5, 0))+
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Species evenness, ", italic("E"))))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

E_IBM

ggsave("./output/IBM_E.pdf")
ggsave("./output/IBM_E.png", width = 6.5, height = 5)


P_IBM <- ggplot(data = subset(IBM_sum, log(IBM_sum$V, 10) <= 2 & log(IBM_sum$V, 10) > 1), aes(y = log(P, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(1, 5))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-2, 1.5))+
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Productivity, ", italic("P"))))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

P_IBM


ggsave("./output/IBM_P.pdf")
ggsave("./output/IBM_P.png", width = 6.5, height = 5)


B_IBM <- ggplot(data = subset(IBM_sum, log(IBM_sum$V, 10) <= 2 & log(IBM_sum$V, 10) > 1), aes(y = B, x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(1, 5))+
  ylim(c(0,2))+ 
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Species turnover, ", beta[w])))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

B_IBM


ggsave("./output/IBM_B.pdf")
ggsave("./output/IBM_B.png", width = 6.5, height = 5)

Res_IBM <- ggplot(data = subset(IBM_sum, log(IBM_sum$V, 10) <= 2 & log(IBM_sum$V, 10) > 1), aes(y = log(Res, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(1, 5))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-2, 1))+
  xlab(expression(paste(tau)))+
  ylab("Resource specialization")+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

Res_IBM


ggsave("./output/IBM_Res.pdf")
ggsave("./output/IBM_Res.png", width = 6.5, height = 5)
```

```{r}
# IBMT <- read.csv("data/IBM/SimData_R2_N6.csv", header = TRUE, sep = ",")
# 
# IBMT_long <- as.data.frame(unique(IBMT$sim))
# colnames(IBMT_long) <- c("sim")
# IBMT_long$ct <- rep(c(1000), 50)
# 
# IBMT_long[IBMT_long$sim == 0, "V"] <- mean(subset(IBMT, IBMT$sim == 0)$V)
# 
# for(x in unique(IBMT_long$sim)){
#   IBMT_long[IBMT_long$sim == x, "V"] <- mean(subset(IBMT, IBMT$sim == x)$V)
#   IBMT_long[IBMT_long$sim == x, "Q"] <- mean(subset(IBMT, IBMT$sim == x)$Q)
#   IBMT_long[IBMT_long$sim == x, "N"] <- mean(subset(IBMT, IBMT$sim == x)$total.abundance)
#   IBMT_long[IBMT_long$sim == x, "S"] <- mean(subset(IBMT, IBMT$sim == x)$species.richness)
#   IBMT_long[IBMT_long$sim == x, "E"] <- mean(subset(IBMT, IBMT$sim == x)$simpson.e, na.rm = TRUE)
#   IBMT_long[IBMT_long$sim == x, "P"] <- mean(subset(IBMT, IBMT$sim == x)$ind.production, na.rm = TRUE)
#   IBMT_long[IBMT_long$sim == x, "B"] <- mean(subset(IBMT, IBMT$sim == x)$whittakers.turnover, na.rm = TRUE)
#   IBMT_long[IBMT_long$sim == x, "Res"] <- mean(subset(IBMT, IBMT$sim == x)$avg.per.capita.efficiency1e, na.rm = TRUE)
#   IBMT_long[IBMT_long$sim == x, "R"] <- mean(subset(IBMT, IBMT$sim == x)$resource.particles, na.rm = TRUE)
# }
# 
# IBMT_long$N_turn <- IBMT_long$ct/(IBMT_long$V/IBMT_long$Q)
# IBMT_long$turn <- IBMT_long$N_turn > 1
# IBMT_long$ct_f <- as.factor(IBMT_long$ct)
# IBMT_long$Tau <- log(IBMT_long$V/IBMT_long$Q, 10)
# 
# write.csv(IBMT_long, "data/IBM/IBM_R2_N4.csv", row.names = FALSE)
# write.csv(IBMT_long, "data/IBM/IBM_R3_N4.csv", row.names = FALSE)
# write.csv(IBMT_long, "data/IBM/IBM_R0_N4.csv", row.names = FALSE)
# write.csv(IBMT_long, "data/IBM/IBM_R2_N5.csv", row.names = FALSE)
# write.csv(IBMT_long, "data/IBM/IBM_R2_N6.csv", row.names = FALSE)

IBM_R2_N4<- read.csv("data/IBM/IBM_R2_N4.csv", header = TRUE, sep = ",")
IBM_R2_N4$ct_f <- as.factor(IBM_R2_N4$ct)

IBM_R3_N4 <- read.csv("data/IBM/IBM_R3_N4.csv", header = TRUE, sep = ",")
IBM_R3_N4$ct_f <- as.factor(IBM_R3_N4$ct)

IBM_R0_N4 <- read.csv("data/IBM/IBM_R0_N4.csv", header = TRUE, sep = ",")
IBM_R0_N4$ct_f <- as.factor(IBM_R0_N4$ct)

IBM_R2_N5 <- read.csv("data/IBM/IBM_R2_N5.csv", header = TRUE, sep = ",")
IBM_R2_N5$ct_f <- as.factor(IBM_R2_N5$ct)

IBM_R2_N6<- read.csv("data/IBM/IBM_R2_N6.csv", header = TRUE, sep = ",")
IBM_R2_N6$ct_f <- as.factor(IBM_R2_N6$ct)

PR <- ggplot(IBM_R0_N4, aes(x = Tau, y = P))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
#  xlab("Number of turnovers")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  geom_point(data = IBM_R2_N4, aes(x = Tau, y = P), color = "red")+
  geom_point(data = IBM_R3_N4, aes(x = Tau, y = P), color = "blue")

RR <- ggplot(IBM_R0_N4, aes(x = Tau, y = log(R, 10)))+
  geom_point()+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  theme(axis.title.x = element_blank())+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("R")+
  geom_point(data = IBM_R2_N4, aes(x = Tau, y = log(R, 10)), color = "red")+
  geom_point(data = IBM_R3_N4, aes(x = Tau, y = log(R, 10)), color = "blue")

NR <- ggplot(IBM_R0_N4, aes(x = Tau, y = N))+
  geom_point()+
  theme(axis.title.x = element_blank())+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  geom_point(data = IBM_R2_N4, aes(x = Tau, y = N), color = "red")+
  geom_point(data = IBM_R3_N4, aes(x = Tau, y = N), color = "blue")

ggdraw()+
  draw_plot(RR, x = 0, y = 0.65, width = 1, height = 0.3) +
  draw_plot(NR, x = 0, y = 0.35, width = 1, height = 0.3) + 
  draw_plot(PR, x = 0, y = 0, width = 1, height = 0.35) +
  theme(plot.background = element_rect(fill="white", color = NA))

ggsave("./output/R_test.pdf")
ggsave("./output/R_test.png", width = 10, height = 10)
```

```{r}
PN <- ggplot(IBM_R2_N4, aes(x = Tau, y = log(P+1, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-4, 3))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
#  xlab("Number of turnovers")+
  ylab("P")+
  geom_point(data = IBM_R2_N5, aes(x = Tau, y = log(P+1, 10)), color = "red")+
  geom_point(data = IBM_R2_N6, aes(x = Tau, y = log(P+1, 10)), color = "blue")

EN <- ggplot(IBM_R2_N4, aes(x = Tau, y = log(E, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-4, 3))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  theme(axis.title.x = element_blank())+
  ylab("E")+
  geom_point(data = IBM_R2_N5, aes(x = Tau, y = log(E, 10)), color = "red")+
  geom_point(data = IBM_R2_N6, aes(x = Tau, y = log(E, 10)), color = "blue")

SN <- ggplot(IBM_R2_N4, aes(x = Tau, y = log(S+1, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-4, 3))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  theme(axis.title.x = element_blank())+
  ylab("S")+
  geom_point(data = IBM_R2_N5, aes(x = Tau, y = log(S+1, 10)), color = "red")+
  geom_point(data = IBM_R2_N6, aes(x = Tau, y = log(S+1, 10)), color = "blue")

BN <- ggplot(IBM_R2_N4, aes(x = Tau, y = log(B, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-4, 3))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  theme(axis.title.x = element_blank())+
  ylab("Beta w")+
  geom_point(data = IBM_R2_N5, aes(x = Tau, y = log(B, 10)), color = "red")+
  geom_point(data = IBM_R2_N6, aes(x = Tau, y = log(B, 10)), color = "blue")

RN <- ggplot(IBM_R2_N4, aes(x = Tau, y = Res))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-4, 3))+
#  xlab("Number of turnovers")+
  xlab(expression(paste(tau)))+
  ylab("Resource Specialization")+
  geom_point(data = IBM_R2_N5, aes(x = Tau, y = Res), color = "red")+
  geom_point(data = IBM_R2_N6, aes(x = Tau, y = Res), color = "blue")

NN <- ggplot(IBM_R2_N4, aes(x = Tau, y = log(N+1, 10)))+
  geom_point()+
  theme(axis.title.x = element_blank())+
  ylab("N")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-4, 3))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  geom_point(data = IBM_R2_N5, aes(x = Tau, y = log(N+1, 10)), color = "red")+
  geom_point(data = IBM_R2_N6, aes(x = Tau, y = log(N+1, 10)), color = "blue")

ggdraw()+
  draw_plot(NN, x = 0, y = 0.65, width = 0.5, height = 0.3) +
  draw_plot(EN, x = 0.5, y = 0.65, width = 0.5, height = 0.3) +
  draw_plot(SN, x = 0, y = 0.35, width = 0.5, height = 0.3) +
  draw_plot(BN, x = 0.5, y = 0.35, width = 0.5, height = 0.3) +
  draw_plot(PN, x = 0, y = 0, width = 0.5, height = 0.35) +
  draw_plot(RN, x = 0.5, y = 0, width = 0.5, height = 0.35) +
  theme(plot.background = element_rect(fill="white", color = NA))

ggsave("./output/N_test.pdf")
ggsave("./output/N_test.png", width = 10, height = 10)
```

```{r}
IBMIC <- read.csv("data/IBM/SimData_InitComm.csv", header = TRUE, sep = ",")
# 
# IBMIC_long <- as.data.frame(rep(unique(IBMIC$sim), each = 3))
# colnames(IBMIC_long) <- c("sim")
# IBMIC_long$ct <- rep(c(100,1000, 10000), 1000)
# 
# IBMIC_long[IBMIC_long$sim == 0 & IBMIC_long$ct == 1000, "V"] <- mean(subset(IBMIC, IBMIC$sim == 0)$V)
# 
for(x in unique(IBMIC_long$sim)){
  for(n in c(100, 1000, 10000)){
 # IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "V"] <- mean(subset(IBMIC, IBMIC$sim == x)$V)
 # IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "Q"] <- mean(subset(IBMIC, IBMIC$sim == x)$Q)
 #  IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "N"] <- mean(subset(IBMIC, IBMIC$sim == x & IBMIC$ct > n-100 & IBMIC$ct < n)$total.abundance)
 #  IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "S"] <- mean(subset(IBMIC, IBMIC$sim == x & IBMIC$ct > n-100 & IBMIC$ct < n)$species.richness)
 #  IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "E"] <- mean(subset(IBMIC, IBMIC$sim == x & IBMIC$ct > n-100 & IBMIC$ct < n)$simpson.e, na.rm = TRUE)
 #  IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "P"] <- mean(subset(IBMIC, IBMIC$sim == x & IBMIC$ct > n-100 & IBMIC$ct < n)$ind.production, na.rm = TRUE)
 #  IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "B"] <- mean(subset(IBMIC, IBMIC$sim == x & IBMIC$ct > n-100 & IBMIC$ct < n)$whittakers.turnover, na.rm = TRUE)
 #   IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "Res"] <- mean(subset(IBMIC, IBMIC$sim == x & IBMIC$ct > n-100 & IBMIC$ct < n)$avg.per.capita.efficiency1e, na.rm = TRUE)
   IBMIC_long[IBMIC_long$sim == x & IBMIC_long$ct == n, "R"] <- mean(subset(IBMIC, IBMIC$sim ==x & IBMIC$ct > n-100 & IBMIC$ct < n)$resource.particles)
  }
}
# 
# IBMIC_long$N_turn <- IBMIC_long$ct/(IBMIC_long$V/IBMIC_long$Q)
# IBMIC_long$turn <- IBMIC_long$N_turn > 1
# IBMIC_long$ct_f <- as.factor(IBMIC_long$ct)
# IBMIC_long$Tau <- log(IBMIC_long$V/IBMIC_long$Q, 10)
#
# write.csv(IBMIC_long, "data/IBM/IBMIC_long.csv", row.names = FALSE)

IBMIC_long <- read.csv("data/IBM/IBMIC_long.csv", header = TRUE, sep = ",")
IBMIC_long$ct_f <- as.factor(IBMIC_long$ct)

plot(subset(IBMIC_long, IBMIC_long$ct == 1000)$R ~ subset(IBMIC_long, IBMIC_long$ct == 1000)$Tau)
```

```{r}
N_IBMIC <- ggplot(data = subset(IBMIC_long, IBMIC_long$ct == 1000 & log(IBMIC_long$V, 10) <= 2 & log(IBMIC_long$V, 10) > 1), aes(y = log(N, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
#  ylab(expression(paste("Total abundance, ", italic("N"))))+
  ylab("Abundance")+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25), axis.text = element_text(size = 20))

N_IBMIC

ggsave("./output/IBMIC_N.pdf")
ggsave("./output/IBMIC_N.png", width = 6.5, height = 5)


S_IBMIC <- ggplot(data = subset(IBMIC_long, IBMIC_long$ct == 1000 & log(IBMIC_long$V, 10) <= 2 & log(IBMIC_long$V, 10) > 1), aes(y = log(S, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
#  ylab(expression(paste("Species richness, ", italic("S"))))+
  ylab("# of species")+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25), axis.text = element_text(size = 20))

S_IBMIC

ggsave("./output/IBMIC_S.pdf")
ggsave("./output/IBMIC_S.png", width = 6.5, height = 5)

E_IBMIC <- ggplot(data = subset(IBMIC_long, IBMIC_long$ct == 1000 & log(IBMIC_long$V, 10) <= 2 & log(IBMIC_long$V, 10) > 1), aes(y = log(E, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force), limits = c(-2,0))+
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Species evenness, ", italic("E"))))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

E_IBMIC

ggsave("./output/IBMIC_E.pdf")
ggsave("./output/IBMIC_E.png", width = 6.5, height = 5)


B_IBMIC <- ggplot(data = subset(IBMIC_long, IBMIC_long$ct == 1000 & log(IBMIC_long$V, 10) <= 2 & log(IBMIC_long$V, 10) > 1), aes(y = B, x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
  ylab(expression(paste("Species turnover, ", beta[w])))+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

B_IBMIC

ggsave("./output/IBMIC_B.pdf")
ggsave("./output/IBMIC_B.png", width = 6.5, height = 5)


P_IBMIC <- ggplot(data = subset(IBMIC_long, IBMIC_long$ct == 1000 & log(IBMIC_long$V, 10) <= 2 & log(IBMIC_long$V, 10) > 1), aes(y = log(P, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
#  ylab(expression(paste("Productivity, ", italic("P"))))+
  ylab("Productivity")+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25), axis.text = element_text(size = 20))

P_IBMIC

ggsave("./output/IBMIC_P.pdf")
ggsave("./output/IBMIC_P.png", width = 6.5, height = 5)


Res_IBMIC <- ggplot(data = subset(IBMIC_long, IBMIC_long$ct == 1000 & log(IBMIC_long$V, 10) <= 2 & log(IBMIC_long$V, 10) > 1), aes(y = log(Res, 10), x = log(V/Q, 10)))+
  geom_point()+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))+
  xlab(expression(paste(tau)))+
  ylab("Resource specialization")+
  stat_smooth(method = "loess", color = "blue", cex = 1.25, level = 0.95, fill = alpha("black", 0.4))+
  theme(axis.title = element_text(size = 25))

Res_IBMIC

ggsave("./output/IBMIC_Res.pdf")
ggsave("./output/IBMIC_Res.png", width = 6.5, height = 5)
```