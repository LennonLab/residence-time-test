---
title: "Residence Time Experiment"
author: "Emmi Mueller"
date: "July 23, 2019"
output:
  pdf_document: default
  html_document: default
---
```{r setup, include = FALSE}
rm(list=ls())
getwd()
```

```{r}
package.list <- c("png", "vegan", "ggplot2", "ggpubr", "cowplot", "ggpmisc", "scales", "fitdistrplus", "tidyr", "ade4", "viridis", "gplots", "BiodiversityR", "indicspecies", "knitr", "here", "dplyr", "BiocManager", "car", "here", "actuar", "tibble", "scales", "dplyr")

for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package)
    library(package, character.only=T)
  } }

BiocManager::valid()
BiocManager::install("flowCore")
BiocManager::install("ggcyto")
BiocManager::install()
```

```{r figure_setup}
my.cols <- RColorBrewer::brewer.pal(n = 4, name = "Greys")[3:4]

# Set theme for figures in the paper
theme_set(theme_classic() + 
  theme(axis.title = element_text(size = 16),
        axis.title.x = element_text(margin = margin(t = 15, b = 15)),
        axis.title.y = element_text(margin = margin(l = 15, r = 15)),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(margin = margin(t = 5)),
        axis.text.y = element_text(margin = margin(r = 5)),
        #axis.line.x = element_line(size = 1),
        #axis.line.y = element_line(size = 1),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.x = element_line(size = 1),
        axis.ticks.y = element_line(size = 1),
        axis.ticks.length = unit(.1, "in"),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        strip.text = element_text(size = 14),
        strip.background = element_blank()
        ))
```

```{r}
BP_fxn <- function(CPMs, Tau, set){
  ##extract whole experiment info from top of csv
  
  #date experiment was run
  date <- as.Date(as.character(CPMs[1,2]), "%m/%d/%Y")

  
  #date the standard was produced
  date_std <- as.Date(as.character(CPMs[2,2]), "%m/%d/%Y")
  
  #DPM of the standard at date of production
  DPM_std <- as.double(as.character(CPMs[3,2]))
  
  #DPM of the standard based on scintillation counter on experiment date
  DPM_curr <- as.double(as.character(CPMs[4,2]))
  
  #half life of tritium - 12.346 years
  half_life <- as.double(as.character(CPMs[5,2]))
  
  #Mols of leucine in each tube based on hot leucine stock concentration
  M_Leu <- as.double(as.character(CPMs[6,2]))
  
  #CPMs of the voucher on experiment date
  Voucher <- as.double(as.character(CPMs[7,2]))
  
  ##remove whole experiment info from top of dataframe
  CPMs <- CPMs[-c(1:9),]
  colnames(CPMs) <- c("Sample", "CPM", "Kill")


  ##calculate time from the experiment date to the standard production date
  t <- as.numeric(date - date_std)/365
  
  ##calculate the expected DPMs of the standard based on t
  DPM_exp <- (DPM_std)*exp((-0.693/half_life)*t)
  
  ##calculate scintillation efficiency as DPM ratio
  efficiency <- DPM_curr/DPM_exp
  
  #divide CPMs into kill and sample dataframes
  Kills <- subset(CPMs, Kill == "T")
  CPMs <- subset(CPMs, Kill == "F")
  
  #convert CPMs to DPMs, DPMs = CPMs/efficiency
  CPMs$CPM <- as.numeric(as.character(CPMs$CPM))
  CPMs$DPM <- CPMs$CPM / efficiency
  
  Kills$CPM <- as.numeric(as.character(Kills$CPM))
  Kills$DPM <- Kills$CPM / efficiency
  
  #average DPMs for each sample and add to Tau
  for(x in unique(CPMs$Sample)){
    Tau[Tau$Tau == x, "DPM"] <- as.numeric(mean(CPMs[CPMs$Sample == x, "DPM"]))
  }

  
  #for each sample, subtract the corresponding kill DPM
  for (x in unique(Tau$Tau)){
    if(Tau[Tau$Tau == x, "Set"] == set){
      Tau[Tau$Tau == x, "DPMKills"] <- Tau[Tau$Tau ==x, "DPM"] - (as.numeric(Kills[Kills$Sample == x, "CPM"])/efficiency)
    }
  }
    print(Tau$DPMKills)
  
  #Determine Mols Leucine based on MLeu_sample = MLeu * DPM/voucher
  Tau$MLeu <- (M_Leu * Tau$DPMKills)/Voucher
  
  #Convert MLeu to ug C/L/hr
  Tau$ugCLhr <- Tau$MLeu * 131.2 * (1/0.073)*0.86*2*1000000
  
  
  Tau$uMChr <- Tau$ugCLhr *0.083333
  
  Tau$log_uMChr <- log(Tau$uMChr, 10)
  
  return(Tau)
}
```

  BP[[i]]$Leucine <- ((BP[[i]]$DPM / 2.2e12) / 153) / 1000
  # DPM*1Ci/2.2e12DPM *1mmolLeu/153Ci * 1molLeu/1000mmol
  BP[[i]]$Leucine.per <- (BP[[i]]$Leucine * (1/1) * (1/0.0015))
  # Leu incorporated * 1/time (hrs) * 1/vol (L)
  BP[[i]]$Protein <- ( BP[[i]]$Leucine.per / 0.073 ) * 131.2
  # mol leu * 1 mol protein/0.073 mol leu * 131.2 g protein/1mol protein
  BP[[i]]$Carbon <- BP[[i]]$Protein * (1/0.63) * (0.54/1) * (10^6)
  # g protein * 1 g DW/0.63 g Pro * 0.54 g C/1g DW = gC/l/hr  * 10^6 = ugC/L/Hr


```{r}
Abundance_fxn <- function(N, Tau){
  for(x in unique(N$Sample)){
    Tau$N[Tau$Tau == x] <- mean(N$N[N$Sample == x])
  }
  Tau$log_N <- log(Tau$N, 10)
  
  return(Tau)
}
```

```{r}
OT_fxn <- function(OT, Tau){
  for(x in unique(OT$Tau)){
    Tau$OT[Tau$Tau == x] <- mean(OT$OT[OT$Tau == x])-mean(OT$OT[OT$Tau == 0])
  }
  
  return(Tau)
}
```

```{r}
Met_fxn <- function(Met, Tau){
  for(x in unique(Met$tau)){
    Tau$Shape[Tau$Tau == x] <- Met$shape[Met$tau == x]
    Tau$Scale[Tau$Tau == x] <- Met$scale[Met$tau == x]
  }
  
  return(Tau)
}
```

```{r}
EP_fxn <- function(EP, Tau){
  EP$Tau <- as.numeric(EP$Tau)
  for(x in unique(EP$Tau)){
    Tau$NumRes[Tau$Tau == x] <- EP$NumRes[EP$Tau == x]
    Tau$AvgRes[Tau$Tau == x] <- EP$Avg[EP$Tau ==x]
  }
  
  return(Tau)
}
```

```{r}
process <- function(x = "", channel = "", scale = ""){
  if(scale == TRUE){
    fcs <- flowCore::read.FCS(file = x, transformation = "scale")
  }
  else{
    fcs <- flowCore::read.FCS(file = x)
  }
  flow <- flowCore::exprs(fcs)
  RSG_H <- as.data.frame(flow[,channel])
  rac <- RAC(x = RSG_H)
  return(rac)
}
```

```{r}
Pareto <- function(x = "", pareto_para = ""){
  head(x)
  pareto <- fitdist(x[ ,2], "pareto", start = list(shape = 0.1, scale = 10))
  pareto_para <- rbind(pareto_para, c(pareto$estimate[1], pareto$estimate[2]))
  return(pareto_para)
}
```

```{r}
RAC <- function(x = ""){
  x = as.vector(x)
  x.ab = x[x >0]
  rac = x.ab[order(x.ab, decreasing = TRUE)]
  ranks <- as.vector(seq(1,length(rac)))
  rac <- cbind(ranks, rac)
  return(as.data.frame(rac))
}

```

#Cdist function takes in a list of activity values and calculates the CDF and returns the CDF and percentage of cells contributing to CDF
```{r}
CDist <- function(x = ""){
  x <- as.vector(x)
  sum <- sum(x)
  rank <- 1
  total <- length(x)
  cdist <- as.vector((x[1]/sum)*100)
  Per <- as.vector((rank/total) * 100)
  for(num in x){
    rank <- rank + 1
    x <- x[-1]
    current <- cdist[length(cdist)] + ((x[1]/sum)*100)
    Per <- c(Per, ((rank/total) *100))
    cdist <- c(cdist, current)
  }
  ranked <- cbind(cdist, Per)
  return(as.data.frame(ranked))

}
```

Read in data
```{r}
#Tau read in
Tau <- read.csv("data/RTLC/2021_RTLC_Tau.csv", header = TRUE)

#Abundance data
Tau <- Abundance_fxn(read.csv("data/RTLC/RTLC_S1/20210602_RTLC_S1_N.csv", header = TRUE), Tau)
Tau <- Abundance_fxn(read.csv("data/RTLC/RTLC_S2/20210628_RTLC_S2_N.csv", header = TRUE), Tau)


#Biofilm data
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S1/20210602_RTLC_S1_Otoole.csv", header = TRUE), Tau)
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S2/20210628_RTLC_S2_Otoole.csv", header = TRUE), Tau)
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S3/20210723_RTLC_S3_Otoole.csv", header = TRUE), Tau)
Tau <- OT_fxn(read.csv("data/RTLC/RTLC_S4/20210904_RTLC_S4_Otoole.csv", header = TRUE), Tau)


#BP data
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S1/20210602_RTLC_S1_BP.csv", header = FALSE), Tau, 1))
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S2/20210628_RTLC_S2_BP.csv", header = FALSE), Tau, 2))
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S3/20210723_RTLC_S3_BP.csv", header = FALSE), Tau, 3))
Tau <- as.data.frame(BP_fxn(read.csv("data/RTLC/RTLC_S4/20210904_RTLC_S4_BP.csv", header = FALSE), Tau, 4))
Tau$ind_P <- Tau$ugCLhr/Tau$N


#Biolog data
Tau <- EP_fxn(read.csv("data/RTLC/eco.data_rt.txt", header = TRUE, sep = "\t"), Tau)

#Format data
Tau$Tau <- as.numeric(Tau$Tau)
Tau$Set <- as.character(Tau$Set)
```

```{r}
ra_rac_2875Ra <- process(here("data", "RTLC", "RTLC_S3", "RTLC_S3_RSG", "2.875Ra.fcs"), "B586-H", TRUE)
ra_CD_2875Ra <- CDist(ra_rac_2875Ra[,2])

ra_rac_325Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "3.25Ra.fcs"), "B586-H", TRUE)
ra_CD_325Ra <- CDist(ra_rac_325Ra[,2])

ra_rac_3875Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "3.875Ra.fcs"), "B586-H", TRUE)
ra_CD_3875Ra <- CDist(ra_rac_3875Ra[,2])

ra_rac_4125Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "4.125Ra.fcs"), "B586-H", TRUE)
ra_CD_4125Ra <- CDist(ra_rac_4125Ra[,2])

ra_rac_4375Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "4.375Ra.fcs"), "B586-H", TRUE)
ra_CD_4375Ra <- CDist(ra_rac_4375Ra[,2])

ra_rac_4625Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "4.625Ra.fcs"), "B586-H", TRUE)
ra_CD_4625Ra <- CDist(ra_rac_4625Ra[,2])

ra_rac_4875Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "4.875Ra.fcs"), "B586-H", TRUE)
ra_CD_4875Ra <- CDist(ra_rac_4875Ra[,2])

ra_rac_5125Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "5.125Ra.fcs"), "B586-H", TRUE)
ra_CD_5125Ra <- CDist(ra_rac_5125Ra[,2])

ra_rac_5375Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "5.375Ra.fcs"), "B586-H", TRUE)
ra_CD_5375Ra <- CDist(ra_rac_5375Ra[,2])

ra_rac_5625Ra <- process(here("data", "RTLC", "RTLC_S3","RTLC_S3_RSG", "5.625Ra.fcs"), "B586-H", TRUE)
ra_CD_5625Ra <- CDist(ra_rac_5625Ra[,2])

met <- list(ra_rac_2875Ra, ra_rac_325Ra, ra_rac_3875Ra, ra_rac_4125Ra, ra_rac_4375Ra, ra_rac_4625Ra, ra_rac_4875Ra, ra_rac_5125Ra, ra_rac_5375Ra, ra_rac_5625Ra)
pareto_para <- data.frame()
for(x in met){
  pareto_para <- Pareto(x, pareto_para)
}
tau <- c(2.875, 3.25, 3.875, 4.125, 4.375, 4.625, 4.875, 5.125, 5.375, 5.625)
met_tau <- data.frame(tau, pareto_para)
names(met_tau) <- c("tau", "shape", "scale")

Tau <- Met_fxn(met_tau, Tau)
```

```{r}

shape <- ggplot(met_tau, aes(x = tau, y = shape))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("Shape parameter")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

shape

ggsave("./output/RTLC_met_shape.pdf")
ggsave("./output/RTLC_met_shape.png")

shape_BP <- ggplot(Tau, aes(x = uMChr, y = Shape, color = Tau))+
  geom_point(size = 3)+
  xlab("Biomass Production (uM C/hr)")+
  ylab("Shape parameter")+
  labs(color = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))

shape_BP

ggsave("./output/RTLC_met_shape_BP.pdf")
ggsave("./output/RTLC_met_shape_BP.png")

scale <- ggplot(met_tau, aes(x = tau, y = scale))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("Scale parameter")+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

scale

ggsave("./output/RTLC_met_scale.pdf")
ggsave("./output/RTLC_met_scale.png")

scale_BP <- ggplot(Tau, aes(x = uMChr, y = Scale, color = Tau))+
  geom_point(size = 3)+
  xlab("Biomass Production (uM C/hr)")+
  ylab("Scale parameter")+
  labs(color = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))

scale_BP

ggsave("./output/RTLC_met_scale_BP.pdf")
ggsave("./output/RTLC_met_scale_BP.png")
```

```{r}

hist <- ggplot(ra_rac_2875Ra, aes(x = rac))+
  geom_histogram(size = 1, alpha = 0.6, color = "#481567FF")+
  geom_histogram(data = ra_rac_325Ra, aes(x = rac),size = 1, alpha = 0.6, color = "#453781FF")+
  geom_histogram(data = ra_rac_3875Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#39568CFF")+
  geom_histogram(data = ra_rac_4125Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#2D708EFF")+
  geom_histogram(data = ra_rac_4375Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#238A8DFF")+
  geom_histogram(data = ra_rac_4625Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#20A387FF")+
  geom_histogram(data = ra_rac_4875Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#3CBB75FF")+
  geom_histogram(data = ra_rac_5125Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#73D055FF")+
  geom_histogram(data = ra_rac_5375Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#B8DE29FF")+
  geom_histogram(data = ra_rac_5625Ra, aes(x = rac),size = 1, alpha = 0.6,color = "#FDE725FF")+
  xlab("RSG activity")+
  ylab("Count")

hist

ggsave("./output/RTLC_met_hist.pdf")
ggsave("./output/RTLC_met_hist.png")

CD <- ggplot(ra_CD_2875Ra, aes(x = Per, y = cdist))+
  geom_point(size = 1, alpha = 0.6, color = "#481567FF")+
  geom_point(data = ra_CD_325Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6, color = "#453781FF")+
  geom_point(data = ra_CD_3875Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#39568CFF")+
  geom_point(data = ra_CD_4125Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#2D708EFF")+
  geom_point(data = ra_CD_4375Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#238A8DFF")+
  geom_point(data = ra_CD_4625Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#20A387FF")+
  geom_point(data = ra_CD_4875Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#3CBB75FF")+
  geom_point(data = ra_CD_5125Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#73D055FF")+
  geom_point(data = ra_CD_5375Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#B8DE29FF")+
  geom_point(data = ra_CD_5625Ra, aes(x = Per, y = cdist),size = 1, alpha = 0.6,color = "#FDE725FF")+
  geom_abline(slope = 1)+
  xlab("% of rank-ordered cells \ncontributing to activity")+
  ylab("Cumulative % \nRSG activity")

CD

ggsave("./output/RTLC_met_CD.pdf")
ggsave("./output/RTLC_met_CD.png")
```

```{r}
N_lm <- lm(N ~ Tau, data = Tau)
N_lm_2 <- lm(N ~ poly(Tau, 2, raw = TRUE), data = Tau)
summary(N_lm)
summary(N_lm_2)
AIC(N_lm)
AIC(N_lm_2)

N <- ggplot(Tau, aes(x = Tau, y = N))+
  geom_point(size = 2, alpha = 0.6)+
  ylim(c(0.5e+07, 3.5e+07))+
  xlab("Tau")+
  ylab("N")+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

N

ggsave("./output/RTLC_N.pdf")
ggsave("./output/RTLC_N.png")

IP_lm <- lm(ind_P ~ Tau, data = Tau)
IP_lm_2 <- lm(ind_P ~ poly(Tau, 2, raw = TRUE), data = Tau)
summary(IP_lm)
summary(IP_lm_2)
AIC(IP_lm)
AIC(IP_lm_2)

IP <- ggplot(Tau, aes(x = Tau, y = ind_P))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("IP")+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))

IP

```


```{r}
OT_lm <- lm(OT ~ Tau, data = Tau)
OT_lm_int <- lm(OT ~ Tau + Set + Tau * Set, data = Tau)
OT_lm_2 <- lm(OT ~ poly(Tau, 2, raw = TRUE), data = Tau)
summary(OT_lm)
summary(OT_lm_int)
summary(OT_lm_2)
AIC(OT_lm)
AIC(OT_lm_int)
AIC(OT_lm_2)


OT_Set <- ggplot(Tau, aes(x = Tau, y = OT, color = Set))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("Biofilm Formation \n (OD 595 nm)")+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_color_manual(values = c("red", "blue", "black", "green"), labels = c("Set 1", "Set 2", "Set 3", "Set 4"))

OT_Set

ggsave("./output/RTLC_OT_Set.pdf")
ggsave("./output/RTLC_OT_Set.png")

OT <- ggplot(Tau, aes(x = Tau, y = OT))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("Biofilm Formation \n (OD 595 nm)")+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

OT

ggsave("./output/RTLC_OT.pdf")
ggsave("./output/RTLC_OT.png")
```

#Bacterial Productivity

```{r}
BP_lm <- lm(log_uMChr ~ Tau, data = Tau)
BP_lm_2 <- lm(uMChr ~ poly(Tau, 2, raw = TRUE), data = Tau)
BP_ne <- 
summary(BP_lm)
summary(BP_lm_2)
AIC(BP_lm)
AIC(BP_lm_2)

BP_poly <- ggplot(Tau, aes(x = Tau, y = uMChr))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("Biomass Production (uM C/hr)")+
  geom_smooth(method = "lm", formula = y~poly(x,2, raw = TRUE))+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~poly(x,2,raw = TRUE), parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

BP_poly

ggsave("./output/RTLC_BP_poly.pdf")
ggsave("./output/RTLC_BP_poly.png")

BP_exp <- ggplot(Tau, aes(x = Tau, y = log_uMChr))+
  geom_point(size = 2, alpha = 0.6)+
  xlab("Tau")+
  ylab("Biomass Production (uM C/hr)")+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  scale_y_continuous(labels = label_math(expr = 10^.x, format = force))

BP_exp

ggsave("./output/RTLC_BP_exp.pdf")
ggsave("./output/RTLC_BP_exp.png")

plot(BP_lm)
plot(BP_lm_2)
```

#Resource Use

##Total number of resources used at 48 hours

```{r}
NR_lm <- lm(NumRes ~ Tau, data = Tau)
NR_lm_2 <- lm(NumRes ~ poly(Tau, 2, raw = TRUE), data = Tau)
summary(NR_lm)
summary(NR_lm_2)
AIC(NR_lm)
AIC(NR_lm_2)

NumRes <- ggplot(Tau, aes(x = Tau, y = NumRes))+
  geom_point(size = 2, alpha = 0.6)+
  xlab(expression(tau))+
  ylab("Number of Resources Used \n at 48 hours")+
  # geom_smooth(method = "lm", formula = y~x)+
  # stat_poly_eq(aes(label = paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
  #              formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

NumRes

ggsave("./output/RTLC_NumRes.pdf")
ggsave("./output/RTLC_NumRes.png")
```

##Average well response at 48 hours

```{r}
Avg_lm <- lm(AvgRes ~ Tau, data = Tau)
Avg_lm_2 <- lm(AvgRes ~ poly(Tau, 2, raw = TRUE), data = Tau)
summary(Avg_lm)
summary(Avg_lm_2)
AIC(Avg_lm)
AIC(Avg_lm_2)

AvgRes <- ggplot(Tau, aes(x = Tau, y = AvgRes))+
  geom_point(size = 2, alpha = 0.6)+
  xlab(expression(tau))+
  ylab("Average Well Response at \n48 hours (OD590)")+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label = paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))


AvgRes

ggsave("./output/RTLC_AvgRes.pdf")
ggsave("./output/RTLC_AvgRes.png")

```

##Load Resource Use data for first 72 hours

```{r}
EcoPlate_72 <- read.csv("data/RTLC/eco.data_rt_S1_0.txt", header = TRUE, sep = "\t")
file_list <- c("data/RTLC/eco.data_rt_S1_24.txt", "data/RTLC/eco.data_rt_S1_48.txt", "data/RTLC/eco.data_rt_S1_72.txt", "data/RTLC/eco.data_rt_S2_0.txt", "data/RTLC/eco.data_rt_S2_24.txt", "data/RTLC/eco.data_rt_S2_48.txt", "data/RTLC/eco.data_rt_S2_72.txt", "data/RTLC/eco.data_rt_S3_0.txt", "data/RTLC/eco.data_rt_S3_24.txt", "data/RTLC/eco.data_rt_S3_48.txt", "data/RTLC/eco.data_rt_S3_72.txt", "data/RTLC/eco.data_rt_S4_0.txt", "data/RTLC/eco.data_rt_S4_24.txt", "data/RTLC/eco.data_rt_S4_48.txt", "data/RTLC/eco.data_rt_S4_72.txt")

for(file in file_list){
  EcoPlate_72 <- rbind(EcoPlate_72, read.csv(file, header = TRUE, sep = "\t"))
}

long_EP <- EcoPlate_72 %>% gather(C_Source, OD, X2.Hydroxy.Benzoic.Acid:Avg)
```

##Plot resource use vs. Time for all Tau

```{r}
Avg_Hr <- ggplot(subset(long_EP, long_EP$C_Source =="Avg"), aes(x = Hours, y = OD, group = Tau, color = Tau))+
  geom_line(size = 1)+
  geom_point(size = 3)+
  xlab("Hours")+
  ylab("Average Well Response (OD590)")+
  labs(group = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))
  
Avg_Hr

ggsave("./output/RTLC_AvgRes_Hr.pdf")
ggsave("./output/RTLC_AvgRes_Hr.png")

```

```{r}
p <- c(0.205, 0.001, 0.007, 0.06, 0.041, 0.041, 0.008, 0.074)

p <- p.adjust(p, method = "BH")

p
```

##Load slopes of resource use data (48-24 hours)

```{r}
EcoPlate_S1 <- read.csv("data/RTLC/eco.data_rt_S1_48.txt", header = TRUE, sep = "\t")
EcoPlate_S1 <- cbind(EcoPlate_S1[,1:2], (EcoPlate_S1[,4:34] - read.csv("data/RTLC/eco.data_rt_S1_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S1[,4:33] <- EcoPlate_S1[,4:33]/48

EcoPlate_S2 <- read.csv("data/RTLC/eco.data_rt_S2_48.txt", header = TRUE, sep = "\t")
EcoPlate_S2 <- cbind(EcoPlate_S2[,1:2], (EcoPlate_S2[,4:34] - read.csv("data/RTLC/eco.data_rt_S2_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S2[,4:33] <- EcoPlate_S2[,4:33]/48

EcoPlate_S3 <- read.csv("data/RTLC/eco.data_rt_S3_48.txt", header = TRUE, sep = "\t")
EcoPlate_S3 <- cbind(EcoPlate_S3[,1:2], (EcoPlate_S3[,4:34] - read.csv("data/RTLC/eco.data_rt_S3_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S3[,4:33] <- EcoPlate_S3[,4:33]/48

EcoPlate_S4 <- read.csv("data/RTLC/eco.data_rt_S4_48.txt", header = TRUE, sep = "\t")
EcoPlate_S4 <- cbind(EcoPlate_S4[,1:2], (EcoPlate_S4[,4:34] - read.csv("data/RTLC/eco.data_rt_S4_24.txt", header = TRUE, sep = "\t")[,4:34]))
EcoPlate_S4[,4:33] <- EcoPlate_S4[,4:33]/48

EcoPlate_Slope <- rbind(EcoPlate_S1, EcoPlate_S2, EcoPlate_S3, EcoPlate_S4)

ResType <- read.csv("code/resource_type.txt", header = TRUE, sep = "\t")

colnames(EcoPlate_Slope) <- c("Tau", "Set", "2-Hydroxy.Benzoic.Acid", "4-Hydroxy.Benzoic.Acid", "alpha-Cyclodextrin", "alpha-D-Lactose", "alpha-Ketobutyric.Acid", "beta-Methyl-D-Glucoside", "D-Cellobiose", "D-Galactonic.Acid.gamma-Lactone", "D-Galacturonic.Acid","D-Glucosaminic.Acid", "D-Malic.Acid", "D-Mannitol", "D-Xylose", "D,L-alpha-Glycerol.Phosphate","gamma-Hydroxybutyric.Acid", "Glucose-1-Phosphate", "Glycogen", "Glycyl-L-Glutamic.Acid", "i-Erythritol","Itaconic.Acid","L-Arginine", "L-Asparagine","L-Phenylalanine", "L-Serine", "L-Threonine","N-Acetyl-D-Glucosamine", "Phenylethylamine", "Putrescine", "Pyruvic.Acid.Methyl.Ester", "Tween.40", "Tween.80")


long_EP_slope <- EcoPlate_Slope %>% gather(C_Source, Slope, "2-Hydroxy.Benzoic.Acid":"Tween.80")

ResType <- distinct(ResType)

long_EP_slope$Type <- NA

for(row in rownames(long_EP_slope)){
  long_EP_slope[row,"Type"] <- ResType$Type[ResType$Resource == long_EP_slope[row,"C_Source"]]
}

lm.slope.tau <- lm(data = subset(long_EP_slope, long_EP_slope$C_Source == "Pyruvic.Acid.Methyl.Ester"), Slope ~ Tau)
summary(lm.slope.tau)
lm.slope.tau.c <- lm(data = long_EP_slope, Slope ~ Tau * C_Source)

summary(lm.slope.tau.c)
anova(lm.slope.tau)

anova(lm.slope.tau, lm.slope.tau.c)
AIC(lm.slope.tau)
AIC(lm.slope.tau.c)

histogram(log(long_EP_slope$Slope, 10))

plot(lm.slope.tau.c)

Res_Slope <- ggplot(long_EP_slope, aes(x = Tau, y = Slope, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  xlab(expression(tau))+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
      formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  theme(legend.position="bottom")

Res_Slope
```

##Ester
```{r}
Res_Slope_Ester <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "ester"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Ester")+
  theme(legend.position="bottom")

  
Res_Slope_Ester

ggsave("./output/RTLC_Res_Slope_ester.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_ester.png", width = 10, height = 8)
```
##Carboxylic Acid 1
```{r}
Res_Slope_CarAc <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "carboxylic acid"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Carboxylic Acid")+
  theme(legend.position="bottom")
  
Res_Slope_CarAc

ggsave("./output/RTLC_Res_Slope_CarAc.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_CarAc.png", width = 10, height = 8)
```
##Carboxylic Acid 2
```{r}
Res_Slope_CarAc_2 <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "carboxylic acid" & long_EP_slope$C_Source != "2-Hydroxy.Benzoic.Acid"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Carboxylic Acid")+
  theme(legend.position="bottom")
  
Res_Slope_CarAc_2

ggsave("./output/RTLC_Res_Slope_CarAc_2.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_CarAc_2.png", width = 10, height = 8)
```
##Carbohydrate
```{r}
Res_Slope_carbo <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "carbohydrate"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Carbohydrate")+
  theme(legend.position="bottom")
  
Res_Slope_carbo

ggsave("./output/RTLC_Res_Slope_Carbo.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_Carbo.png", width = 10, height = 8)
```

##Phosphorylated
```{r}
Res_Slope_phos <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "phosphorylated"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Phosphorylated")+
  theme(legend.position="bottom")
  
Res_Slope_phos

ggsave("./output/RTLC_Res_Slope_phos.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_phos.png", width = 10, height = 8)
```
#Amino Acid
```{r}
Res_Slope_aa <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "amino acid"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Amino Acid")+
  theme(legend.position="bottom")
  
Res_Slope_aa

ggsave("./output/RTLC_Res_Slope_aa.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_aa.png", width = 10, height = 8)
```
#Amine
```{r}
Res_Slope_am <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "amine"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Amine")+
  theme(legend.position="bottom")
  
Res_Slope_am

ggsave("./output/RTLC_Res_Slope_am.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_am.png", width = 10, height = 8)
```

##Polymer
```{r}
Res_Slope_poly <- ggplot(subset(long_EP_slope, long_EP_slope$Type == "polymer"), aes(x = Tau, y = Slope, color = C_Source, group = C_Source))+
  geom_point(size = 3, show.legend = FALSE)+
  geom_smooth(method = "lm", formula = y~x)+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4, label.x = 0.9)+
  xlab(expression(tau))+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))+
  ylab("Slope of Resource Use (24-48 hrs)")+
  labs(title = "Polymer")+
  theme(legend.position="bottom")
  
Res_Slope_poly

ggsave("./output/RTLC_Res_Slope_Poly.pdf", width = 10, height = 8)
ggsave("./output/RTLC_Res_Slope_Poly.png", width = 10, height = 8)
```

##Read in all EcoPlate 48 hour data and create a resource by sample matrix (wbs - well response by site) and environmental matrix (env - Tau only)

```{r}
EcoPlate <- read.csv("data/RTLC/eco.data_rt_S1_48.txt", header = TRUE, sep = "\t")
EcoPlate <- rbind(EcoPlate, read.csv("data/RTLC/eco.data_rt_S2_48.txt", header = TRUE, sep = "\t"))
EcoPlate <- rbind(EcoPlate, read.csv("data/RTLC/eco.data_rt_S3_48.txt", header = TRUE, sep = "\t"))
EcoPlate <- rbind(EcoPlate, read.csv("data/RTLC/eco.data_rt_S4_48.txt", header = TRUE, sep = "\t"))
EcoPlate_env <- subset(EcoPlate, select = Tau)
EcoPlate_env_ex <- subset(EcoPlate, select = c(Tau, Set))
EcoPlate <- subset(EcoPlate, select =-c(Tau, NumRes, Avg, Set, Hours))


```


#Jaccard
```{r}
EP.db <-vegdist(EcoPlate, method = "bray", binary = TRUE)
EP.pca <- cmdscale(EP.db, eig = TRUE)
EP.pca <- add.spec.scores(EP.pca, EcoPlate, method = "pcoa.scores")

explainvar1 <- round(EP.pca$eig[1] / sum(EP.pca$eig), 3) * 100
explainvar2 <- round(EP.pca$eig[2] / sum(EP.pca$eig), 3) * 100
explainvar3 <- round(EP.pca$eig[3] / sum(EP.pca$eig), 3) * 100

EP.plot <- as.data.frame(EP.pca$points)
EP.plot <- cbind(EP.plot, EcoPlate_env_ex)
EP.cproj <- as.data.frame(EP.pca$cproj)
EP.cproj <- cbind(EP.cproj, as.data.frame(row.names(EP.pca$cproj)))

Sor <- ggplot(EP.plot, aes(x = V1, y = V2, colour = Tau))+
  geom_point(cex = 3)+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))


Sor

ggsave("./output/RTLC_EP_Sor.pdf")
ggsave("./output/RTLC_EP_Sor.png")

```

```{r}
EP.eu <-vegdist(EcoPlate, method = "euclidean")
EP.pca <- cmdscale(EP.eu, eig = TRUE)
EP.pca <- add.spec.scores(EP.pca, EcoPlate, method = "pcoa.scores")

explainvar1 <- round(EP.pca$eig[1] / sum(EP.pca$eig), 3) * 100
explainvar2 <- round(EP.pca$eig[2] / sum(EP.pca$eig), 3) * 100
explainvar3 <- round(EP.pca$eig[3] / sum(EP.pca$eig), 3) * 100

EP.plot <- as.data.frame(EP.pca$points)
EP.plot <- cbind(EP.plot, EcoPlate_env_ex)
EP.cproj <- as.data.frame(EP.pca$cproj)
EP.cproj <- cbind(EP.cproj, as.data.frame(row.names(EP.pca$cproj)))

PCA <- ggplot(EP.plot, aes(x = V1, y = V2, colour = Set))+
  geom_point(cex = 3)+
  xlab(paste("PCA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = "Set")+
#  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))


PCA

ggsave("./output/RTLC_EP_PCA.pdf")
ggsave("./output/RTLC_EP_PCA.png")

```

```{r}
EP.db <-vegdist(EcoPlate, method = "bray")
EP.pcoa <- cmdscale(EP.db, eig = TRUE)
EP.pcoa <- add.spec.scores(EP.pcoa, EcoPlate, method = "pcoa.scores")

explainvar1 <- round(EP.pcoa$eig[1] / sum(EP.pcoa$eig), 3) * 100
explainvar2 <- round(EP.pcoa$eig[2] / sum(EP.pcoa$eig), 3) * 100
explainvar3 <- round(EP.pcoa$eig[3] / sum(EP.pcoa$eig), 3) * 100

EP.plot <- as.data.frame(EP.pcoa$points)
EP.plot <- cbind(EP.plot, EcoPlate_env)
EP.cproj <- as.data.frame(EP.pcoa$cproj)
EP.cproj <- cbind(EP.cproj, as.data.frame(row.names(EP.pcoa$cproj)))

Bray <- ggplot(EP.plot, aes(x = V1, y = V2, colour = Tau))+
  geom_point(cex = 3)+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))


Bray

ggsave("./output/RTLC_EP_Bray.pdf")
ggsave("./output/RTLC_EP_Bray.png")

```
#

```{r}

PCOA_res <- ggplot(EP.plot, aes(x = V1, y = V2, colour = Tau))+
  geom_point(pch = 19, cex = 3)+
  xlab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  labs(color = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))+
  geom_text(data = EP.cproj, aes(x = Dim1, y = Dim2, label = row.names(EP.pcoa$cproj)),col = "black", cex = 2)


PCOA_res

ggsave("./output/RTLC_EP_PCoA_resources.pdf")
ggsave("./output/RTLC_EP_PCoA_resources.png")

```

#Plot axis against Tau running whatever was the most recent to make EP.plot

```{r}
PC2_lm <- lm(V2 ~ Tau, data = EP.plot)
summary(PC2_lm)

PC2 <- ggplot(EP.plot, aes(x = Tau, y = V2))+
  geom_point(pch=19, cex = 3)+
  ylab(paste("PCoA 2 (", explainvar2, "%)", sep = ""))+
  xlab(expression(tau))+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

PC2

ggsave("./output/RTLC_EP_PCA2.pdf")
ggsave("./output/RTLC_EP_PCA2.png")

PC1_lm <- lm(V1 ~ Tau, data = EP.plot)
summary(PC1_lm)

PC1 <- ggplot(EP.plot, aes(x = Tau, y = V1))+
  geom_point(pch = 19, cex = 3)+
  ylab(paste("PCoA 1 (", explainvar1, "%)", sep = ""))+
  xlab(expression(tau))+
  geom_smooth(method = "lm")+
  stat_poly_eq(aes(label =  paste(stat(rr.label), "*\" and \"*", stat(p.value.label), sep = "")),
               formula = y~x, parse = TRUE, size = 4)+
  scale_x_continuous(labels = label_math(expr = 10^.x, format = force))

PC1

ggsave("./output/RTLC_EP_PCA1.pdf")
ggsave("./output/RTLC_EP_PCA1.png")
```


#dbRDA constrained by Tau (our only environmental variable)

```{r}
EP.dbrda <- dbrda(EP.db ~ ., EcoPlate_env)

png("./output/RTLC_EP_dbRDA_env.png", width = 800, height = 600)
fig <- ordiplot(EP.dbrda, choices = c(1,2), type = "points")
fig
dev.off()

pdf("./output/RTLC_EP_dbRDA_env.pdf")
fig <- ordiplot(EP.dbrda, choices = c(1,2), type = "points")
fig
dev.off()
```

#Not sure what is going on here

```{r}

#plot dbRDA

EP.dbrda.mod0 <- dbrda(EP.db ~ 1, EcoPlate)
ordiplot(EP.dbrda.mod0)
EP.dbrda.mod1 <- dbrda(EP.db ~ ., EcoPlate)
EP.dbrda <- ordiR2step(EP.dbrda.mod0, EP.dbrda.mod1, perm.max = 200)

EP.dbrda$call
EP.dbrda$anova
ordiplot(EP.dbrda)

permutest(EP.dbrda, permutations = 999)
envfit(EP.dbrda, EcoPlate_env, perm = 999)

EP.dbrda.exvar1 <- round(EP.dbrda$CCA$eig[1]/sum(c(EP.dbrda$CCA$eig, EP.dbrda$CA$eig)), 3) * 100
EP.dbrda.exvar2 <- round(EP.dbrda$CCA$eig[2]/sum(c(EP.dbrda$CCA$eig, EP.dbrda$CA$eig)), 3) * 100

EP.dbrda.plot <- as.data.frame(EP.dbrda$CCA$wa)
EP.dbrda.plot <- cbind(EP.dbrda.plot, EcoPlate_env)

dbRDA <- ggplot(EP.dbrda.plot, aes(x = dbRDA1, y = dbRDA2, colour = Tau))+
  geom_point(pch = 19, cex = 3)+
  xlab(paste("dbRDA 1 (", EP.dbrda.exvar1, "%)", sep = ""))+
  ylab(paste("dbRDA 2 (", EP.dbrda.exvar2, "%)", sep = ""))+
  labs(color = "Tau")+
  scale_color_continuous(type = "viridis", labels = label_math(expr = 10^.x, format = force))+
  theme(legend.title = element_text(size = 16))

dbRDA

ggsave("./output/RTLC_EP_dbRDA.pdf")
ggsave("./output/RTLC_EP_dbRDA.png")


#plot dbRDA 

png("./output/RTLC_EP_dbRDA_resources.png", width = 1200, height = 900)
par(mar = c(5,5,4,4) + 0.1)

plot(scores(EP.dbrda, display = "wa"), xlab = paste("dbRDA 1 (", EP.dbrda.exvar1, "%)", sep = ""), ylab = paste("dbRDA 2 (", EP.dbrda.exvar2, "%)", sep = ""), ylim = c(-1.5, 1), xlim = c(-1, 1.5), pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = FALSE)

axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las=1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las=1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
points(scores(EP.dbrda, display = "wa"), pch = 19, cex = 3, bg = "gray", col = "gray")
text(scores(EP.dbrda, display = "wa"), labels = row.names(scores(EP.dbrda, display = "wa")))
vectors <- scores(EP.dbrda, display = "bp")
arrows(0, 0, vectors[,1], vectors[,2], lwd = 2, lty = 1, length = 0.2, col = "red")
text(vectors[,1], vectors[,2], pos = 3, labels = row.names(vectors))
axis(side=3, lwd.ticks = 2, cex.axis=1.2, las = 1, col = "red", lwd = 2.2, at = pretty(range(vectors[,1]))*2, labels = pretty(range(vectors[,1])))
axis(side=4, lwd.ticks = 2, cex.axis=1.2, las = 1, col = "red", lwd = 2.2, at = pretty(range(vectors[,2]))*2, labels = pretty(range(vectors[,2])))

dev.off()

pdf("./output/RTLC_EP_dbRDA_resources.pdf")
par(mar = c(5,5,4,4) + 0.1)

plot(scores(EP.dbrda, display = "wa"), xlab = paste("dbRDA 1 (", EP.dbrda.exvar1, "%)", sep = ""), ylab = paste("dbRDA 2 (", EP.dbrda.exvar2, "%)", sep = ""), pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = FALSE)

axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las=1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las=1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
points(scores(EP.dbrda, display = "wa"), pch = 19, cex = 3, bg = "gray", col = "gray")
text(scores(EP.dbrda, display = "wa"), labels = row.names(scores(EP.dbrda, display = "wa")))
vectors <- scores(EP.dbrda, display = "bp")
arrows(0, 0, vectors[,1], vectors[,2], lwd = 2, lty = 1, length = 0.2, col = "red")
text(vectors[,1], vectors[,2], pos = 3, labels = row.names(vectors))
axis(side=3, lwd.ticks = 2, cex.axis=1.2, las = 1, col = "red", lwd = 2.2, at = pretty(range(vectors[,1]))*2, labels = pretty(range(vectors[,1])))
axis(side=4, lwd.ticks = 2, cex.axis=1.2, las = 1, col = "red", lwd = 2.2, at = pretty(range(vectors[,2]))*2, labels = pretty(range(vectors[,2])))

dev.off()
```

#Code from Kuo et al. 2021 for ordiellipse
```{r}
all.equal(row.names(Brassica.PCoA$points), rownames(Brassica.div))
Brassica.points <- data.frame(Brassica.PCoA$points, Brassica.div)
# Active community
Brassica.active.rpf <- Brassica.points[ which(Brassica.points$type == "cDNA" &
                                   Brassica.points$treatment == "Rpf+"), ]
Brassica.active.no <- Brassica.points[ which(Brassica.points$type == "cDNA" &
                                   Brassica.points$treatment == "Rpf-"), ]
# Total community
Brassica.total.rpf <- Brassica.points[ which(Brassica.points$type == "DNA" &
                                   Brassica.points$treatment == "Rpf+"), ]
Brassica.total.no <- Brassica.points[ which(Brassica.points$type == "DNA" &
                                   Brassica.points$treatment == "Rpf-"), ]
# Add points
# Active community Rpf+
points(Brassica.active.rpf[ ,1], Brassica.active.rpf[ ,2], pch = 21,
       cex = 3.5, col = "Black", bg = "grey15", lwd= 2.5)
# Active community Rpf-
points(Brassica.active.no[ ,1], Brassica.active.no[ ,2], pch = 21,
       cex = 3.5, col = "Black", bg = "lightgrey", lwd= 2.5)   
# Total community Rpf+ 
points(Brassica.total.rpf[ ,1], Brassica.total.rpf[ ,2], pch = 24,
       cex = 3.5, col = "Black", bg = "grey15", lwd= 2.5)
# Total community Rpf-
points(Brassica.total.no[ ,1], Brassica.total.no[ ,2], pch = 24,
       cex = 3.5, col = "Black", bg = "lightgrey", lwd= 2.5)
# Add ellipses 
# Active Rpf+
ordiellipse(cbind(Brassica.active.rpf[ ,1], Brassica.active.rpf[ ,2]), Brassica.active.rpf$treatment, kind="sd", conf=0.95,
            lwd=2, lty=3, draw="lines", col="black", label=FALSE)
# Active Rpf-
ordiellipse(cbind(Brassica.active.no[ ,1], Brassica.active.no[ ,2]), Brassica.active.no$treatment, kind="sd", conf=0.95,
            lwd=2, lty=3, draw="lines", col="black", label=FALSE)
# Total Rpf+
ordiellipse(cbind(Brassica.total.rpf[ ,1], Brassica.total.rpf[ ,2]), Brassica.total.rpf$treatment, kind="sd", conf=0.95,
            lwd=2, lty=3, draw="lines", col="black", label=FALSE)
# Total Rpf- 
ordiellipse(cbind(Brassica.total.no[ ,1], Brassica.total.no[ ,2]), Brassica.total.no$treatment, kind="sd", conf=0.95,
            lwd=2, lty=3, draw="lines", col="black", label=FALSE)
```


#Pilot data code
```{r}
t_Res_rt75 <- ggplot(EcoPlate_t78,aes(x=Time,y=NumRes))+
  geom_point(size=2,alpha=0.6)+
  geom_smooth(method = "lm",formula =y ~ poly(x, 2, raw = TRUE))+
  xlab("Time (hrs)")+
  ylab("Resources Used")+
  stat_poly_eq(formula = y ~ poly(x,2, raw = TRUE), rr.digits = 2,p.digits = 3, parse = TRUE)

ggsave("./output/t_Res_rt75.pdf")
ggsave("./output/t_Res_rt75.png")

Tau.mod <- lm(EcoPlate_allrt$NumRes ~ EcoPlate_allrt$Tau)
Tau.sq.mod <- lm(EcoPlate_allrt$NumRes ~ poly(EcoPlate_allrt$Tau, 2, raw = TRUE))
Tau.lo <- loess(EcoPlate_allrt$NumRes ~ EcoPlate_allrt$Tau, span = 3)
plot(Tau.mod)
AIC(Tau.mod)
summary(Tau.mod)
plot(Tau.sq.mod)
AIC(Tau.sq.mod)
summary(Tau.sq.mod)

Tau_Res <- ggplot(EcoPlate_allrt,aes(x=Tau,y=NumRes))+
  geom_point(size=2,alpha=0.6)+
  geom_smooth(method = "loess", span = 3)+
  xlab(expression(paste("log(", tau,")")))+
  ylab("# of Resources Consumed")

Tau_Res

ggsave("./output/Tau_Res.pdf")
ggsave("./output/Tau_Res.png")


Tau.mod <- lm(log(RT$N, 10) ~ log(RT$Tau, 10))
Tau.sq.mod <- lm(log(RT$N, 10) ~ poly(log(RT$Tau,10), 2, raw = TRUE))
plot(Tau.mod)
AIC(Tau.mod)
summary(Tau.mod)
plot(Tau.sq.mod)
AIC(Tau.sq.mod)
summary(Tau.sq.mod)

N <- ggplot(RT,aes(x=log(Tau, 10),y=log(N, 10)))+
  geom_point(size=2,alpha=0.6)+
  geom_smooth(method = "lm",formula =y ~ poly(x, 2, raw = TRUE))+
  xlab(expression(paste("log(", tau,")")))+
  ylab("log(N)") +
  stat_poly_eq(formula = y ~ poly(x,2, raw = TRUE), rr.digits = 2, parse = TRUE)

ggsave("./output/Tau_N.pdf")
ggsave("./output/Tau_N.png")

model_OT <- lm(RT$OT ~ log(RT$Tau, 10))
summary(model_OT)

OT <- ggplot(RT, aes(x=log(Tau, 10), y = OT))+
  geom_point(size=2, alpha=0.6)+
  geom_smooth(method = "loess", span = 3)+
  xlab(expression(paste("log(", tau,")")))+
  xlim(c(4,7.5))+
  ylab("Biofilm Synthesis - Abs at 550 nm")

ggsave("./output/Tau_Biofilm.pdf")
ggsave("./output/Tau_Biofilm.png")

BR <- ggplot(RT, aes(x=log(Tau, 10), y = BR))+
  geom_point(size=2, alpha=0.6)+
  geom_smooth(method = "lm",formula =y ~ poly(x, 2, raw = TRUE))+
  xlab(expression(paste("log(", tau,")")))+
  ylab(expression(paste("Bacterial respirtaiton (", mu,"M O2/hr)")))+
  stat_poly_eq(formula = y ~ poly(x,2, raw = TRUE), rr.digits = 2, parse = TRUE)

ggsave("./output/Tau_BR.pdf")
ggsave("./output/Tau_BR.png")

BR_N <- ggplot(RT, aes(x = log(Tau,10), y = BR_N))+
  geom_point(size=2, alpha=0.6)+
  geom_smooth(method = "lm",formula =y ~ poly(x, 2, raw = TRUE))+
  xlab(expression(paste("log(", tau,")")))+
  ylab(expression(paste("Bacterial respirtaiton (", mu,"M O2/hr)")))+
  stat_poly_eq(formula = y ~ poly(x,2, raw = TRUE), rr.digits = 2, parse = TRUE)

ggsave("./output/Tau_ind.R.pdf")
ggsave("./output/Tau_ind.R.png")

model_BP_N <- lm(log(RT$BP_N, 10) ~ poly(log(RT$Tau, 10), 2, raw = TRUE))
summary(model_BP_N)

BP_N <- ggplot(RT, aes(x=log(Tau, 10), y = BP_N))+
  geom_point(size=2, alpha=0.6)+
  geom_smooth(method = "loess", span = 3)+
  xlab(expression(paste("log(", tau,")")))+
  ylab(expression(paste("Individual BP (", mu,"M C/hr/cell)")))

ggsave("./output/Tau_ind.P.pdf")
ggsave("./output/Tau_ind.P.png")

model_BP <- lm(log(RT$BP, 10) ~ poly(log(RT$Tau, 10), 2, raw = TRUE))
summary(model_BP)

BP <- ggplot(RT, aes(x=log(Tau, 10), y = BP))+
  geom_point(size=2, alpha=0.6)+
  geom_smooth(method = "loess", span = 3)+
  xlab(expression(paste("log(", tau,")")))+
  ylab(expression(paste("Total BP (",mu, "M C/hr)")))

ggsave("./output/Tau_BP.pdf")
ggsave("./output/Tau_BP.png")

ggarrange(N, BP, BP_N, labels = c("A", "B", "C"), ncol = 3, nrow = 1)
ggsave("./output/Tau_BP_N_BP_N.pdf", width = 15, height = 5)
ggsave("./output/Tau_BP_N_BP_N.png", width = 15, height = 5)

ggarrange(OT, Tau_Res, labels = c("A", "B"), ncol = 2, nrow = 1)
ggsave("./output/Traits.pdf", width = 10, height = 5)
ggsave("./output/Traits.png", width = 10, height = 5)
```

